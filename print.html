<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Getting Started with CheriBSD 23.11</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="cover/index.html">Getting Started with CheriBSD 23.11</a></li><li class="chapter-item expanded "><a href="introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="background/index.html"><strong aria-hidden="true">2.</strong> Background</a></li><li class="chapter-item expanded "><a href="features/index.html"><strong aria-hidden="true">3.</strong> CheriBSD features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="features/kernel.html"><strong aria-hidden="true">3.1.</strong> Kernel compilation modes</a></li><li class="chapter-item expanded "><a href="features/processes.html"><strong aria-hidden="true">3.2.</strong> Process environments</a></li><li class="chapter-item expanded "><a href="features/desktop.html"><strong aria-hidden="true">3.3.</strong> CheriABI desktop environment</a></li><li class="chapter-item expanded "><a href="features/temporal.html"><strong aria-hidden="true">3.4.</strong> Userlevel heap temporal memory safety</a></li><li class="chapter-item expanded "><a href="features/c18n.html"><strong aria-hidden="true">3.5.</strong> Userlevel software compartmentalization</a></li><li class="chapter-item expanded "><a href="features/bhyve.html"><strong aria-hidden="true">3.6.</strong> bhyve hypervisor</a></li></ol></li><li class="chapter-item expanded "><a href="nonfeatures/index.html"><strong aria-hidden="true">4.</strong> Unsupported FreeBSD features</a></li><li class="chapter-item expanded "><a href="getting/index.html"><strong aria-hidden="true">5.</strong> Getting CheriBSD</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="downloading/index.html"><strong aria-hidden="true">5.1.</strong> Downloading image files</a></li><li class="chapter-item expanded "><a href="building/index.html"><strong aria-hidden="true">5.2.</strong> Building image files</a></li></ol></li><li class="chapter-item expanded "><a href="morello/index.html"><strong aria-hidden="true">6.</strong> CheriBSD on an Arm Morello board</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="morello-console/index.html"><strong aria-hidden="true">6.1.</strong> Accessing the Morello console</a></li><li class="chapter-item expanded "><a href="morello-firmware/index.html"><strong aria-hidden="true">6.2.</strong> Upgrading the Morello firmware</a></li><li class="chapter-item expanded "><a href="morello-install/index.html"><strong aria-hidden="true">6.3.</strong> Installing on a Morello board</a></li><li class="chapter-item expanded "><a href="morello-issues/index.html"><strong aria-hidden="true">6.4.</strong> Morello known issues</a></li></ol></li><li class="chapter-item expanded "><a href="packages/index.html"><strong aria-hidden="true">7.</strong> Third-party packages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="packages/limitations.html"><strong aria-hidden="true">7.1.</strong> Limitations of packages</a></li><li class="chapter-item expanded "><a href="packages/missing.html"><strong aria-hidden="true">7.2.</strong> Missing packages</a></li><li class="chapter-item expanded "><a href="packages/upgrading.html"><strong aria-hidden="true">7.3.</strong> Upgrading packages</a></li><li class="chapter-item expanded "><a href="packages/debugging.html"><strong aria-hidden="true">7.4.</strong> Debugging packages</a></li><li class="chapter-item expanded "><a href="packages/commands.html"><strong aria-hidden="true">7.5.</strong> Useful commands</a></li></ol></li><li class="chapter-item expanded "><a href="helloworld/index.html"><strong aria-hidden="true">8.</strong> Compiling &quot;Hello World&quot;</a></li><li class="chapter-item expanded "><a href="benchmarking/index.html"><strong aria-hidden="true">9.</strong> Benchmarking guidance</a></li><li class="chapter-item expanded "><a href="support/index.html"><strong aria-hidden="true">10.</strong> Getting help</a></li><li class="chapter-item expanded "><a href="resources/index.html"><strong aria-hidden="true">11.</strong> Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Getting Started with CheriBSD 23.11</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/CTSRD-CHERI/cheribsd-getting-started" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#getting-started-with-cheribsd-2311" id="getting-started-with-cheribsd-2311">Getting Started with CheriBSD 23.11</a></h1>
<p>Robert N. M. Watson (University of Cambridge)
and
Brooks Davis (SRI International)</p>
<p>This is a living document that describes how to get up and running with
<a href="https://www.cheribsd.org/">CheriBSD</a> on Morello and CHERI-RISC-V.
Topics include how to download and install prebuilt CheriBSD images, how to
build your own images, how third-party packages work, and where to find
further information and support.</p>
<!--
NOTE: A release version is also in SUMMARY.md.
-->
<p><strong>The document describes CheriBSD as of the 23.11 release, unless explicitly
stated in sections referring to earlier or later releases.</strong></p>
<p><em>This document is a work-in-progress.  Feedback and contributions are
welcomed.  Please see our <a href="https://github.com/CTSRD-CHERI/cheribsd-getting-started">GitHub
Repository</a> for the
source code and an issue tracker.
There is a <a href="https://ctsrd-cheri.github.io/cheribsd-getting-started/">rendered version on the
web</a>, which is
automatically updated when the git repository is committed to.</em></p>
<h2><a class="header" href="#acknowledgements" id="acknowledgements">Acknowledgements</a></h2>
<p>The authors gratefully acknowledge Brian Campbell (University of Edinburgh),
Jessica Clarke (University of Cambridge),
George Neville-Neil (MSB Associates), and Konrad Witaszczyk (University of
Cambridge) for their contributions to this document.</p>
<p>This work was supported by the Innovate UK project Digital Security by Design
(DSbD) Technology Platform Prototype, 105694.</p>
<p>This material is based upon work supported by the Defense Advanced
Research Projects Agency (DARPA) under Contract No. HR001122C0110 (&quot;ETC&quot;). Any
opinions, findings and conclusions or recommendations expressed in this
material are those of the author(s) and do not necessarily reflect the
views of the Defense Advanced Research Projects Agency (DARPA).</p>
<h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p><a href="https://www.cheribsd.org/">CheriBSD</a> is a version of the open-source
<a href="https://www.freebsd.org/">FreeBSD</a> operating system that has been extended to
use CHERI architectural protections.
CheriBSD is intended to:</p>
<ul>
<li>Provide a clean, in-depth illustration and template for how CHERI support
can be integrated with a general-purpose, MMU-enabled operating system;</li>
<li>Enable validation and evaluation of CHERI-extended processor architectures
and microarchitectures;</li>
<li>Act as an OS research platform for how operating systems can use CHERI;</li>
<li>Support the development and evaluation of CHERI-enabled applications; and</li>
<li>Provide a foundation for CHERI-enabled software demonstrations.</li>
</ul>
<p>This guide will support you in getting up and running with CheriBSD on the
CHERI-RISC-V and Arm Morello platforms.
As platforms vary substantially, from instruction-set emulators and executable
formal models through to FPGA- and ASIC-based hardware implementations, there
are several paths that can be taken to reach a shell prompt and start
productive work.
You might find that you want to build CheriBSD from scratch, or simply use one
of our downloadable pre-compiled images.
You may want to run directly from a live image in an emulator, or
alternatively want to use an installer image to install onto an internal disk
in an Arm Morello-based server or workstation.</p>
<h1><a class="header" href="#background" id="background">Background</a></h1>
<h2><a class="header" href="#cheri" id="cheri">CHERI</a></h2>
<p><strong>CHERI</strong> is an extension to processor Instruction-Set Architectures (ISAs) to
introduce support for fine-grained memory protection and software
compartmentalization.
This is done by introducing a new architectural data type, the <strong>CHERI
capability</strong>, which can be used to implement pointers with strong integrity,
provenance validity, spatial safety, and monotonicity.
CHERI requires new microarchitectural support, including support for memory
tags that track the provenance validity of capabilities in registers and
memory.
CHERI extensions have been specified for:</p>
<ul>
<li>Arm's 64-bit Armv8-a ISA, with the prototype architecture known as
<strong><a href="https://www.arm.com/architecture/cpu/morello">Morello</a></strong>.
The multi-GHz, multi-core, superscalar Morello design is a CHERI-extended
version of the Arm Neoverse N1, available on an evaluation board from Arm.</li>
<li>The open-source 32-bit and 64-bit RISC-V ISA, with the extended ISA known as
<strong><a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-951.pdf">CHERI-RISC-V</a></strong>.
CHERI-RISC-V is available via multiple open-source soft processor cores for
use on FPGA.</li>
</ul>
<p>ISA-level emulation platforms exist for both architectures (QEMU for
CHERI-RISC-V and Morello, and Arm's Morello FVP for Morello).
Unless you have access to a Morello board or a high-end (and supported) FPGA
development platform, using
<a href="https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-qemu.html">QEMU-CHERI</a>
will be the easiest way to get started using CHERI.
This guide covers all of these use cases.</p>
<p>You can learn more about CHERI by reading the technical report, <a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-941.pdf">An
Introduction to
CHERI</a>.</p>
<h2><a class="header" href="#cheri-cc" id="cheri-cc">CHERI C/C++</a></h2>
<p><strong>CHERI C</strong> and <strong>CHERI C++</strong> are programming-language dialects closely tied
to CHERI-based code generation and Application Binary Interfaces (ABIs) that
directly support referential and spatial memory safety.
These language variants compile to <em>pure-capability code</em>, which implements
all language- and sub-language pointers using CHERI capabilities rather than
architectural integers.
With suitable OS support, they can also support temporal memory safety.</p>
<p>CHERI C/C++ support is implemented by <a href="https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-llvm.html">CHERI
LLVM</a>.
The Clang/LLVM compiler is able to statically identify and report as warnings
many of the incompatibilites between C/C++ and CHERI C/C++ that would result in
run-time CHERI exceptions. However, a correctly compiled CHERI C/C++ program
might still trigger CHERI capability violations at run time (e.g., due to
pointer misalignment) that can be diagnosed with
<a href="https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-software.html">GDB</a>.</p>
<p>You can learn more about CHERI C/C++ and its CheriABI run-time environment by
reading the technical report, <a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-947.pdf">CHERI C/C++ Programming
Guide</a>.</p>
<h2><a class="header" href="#cheribsd" id="cheribsd">CheriBSD</a></h2>
<p><strong>CheriBSD</strong> is an extended version of the open-source
<em><a href="https://www.freebsd.org/">FreeBSD</a></em> operating system.
FreeBSD is a mature UNIX-based operating system able to run on multiple
hardware architectures, and widely used in industry in service, appliance, and
embedded environments.
CheriBSD contains various CHERI-based extensions including support for kernel
and userspace memory safety, and supports multiple software
compartmentalization models.
CheriBSD runs on both CHERI-RISC-V and Morello with nearly identical feature
sets (Morello includes hardware virtualisation extensions not present in the
CHERI-RISC-V cores, and so CHERI-extended bhyve hypervisor support is not
available for CHERI-RISC-V).</p>
<h1><a class="header" href="#cheribsd-features" id="cheribsd-features">CheriBSD features</a></h1>
<p>CheriBSD extends FreeBSD with added CHERI-enabled features, such as kernel and
userspace memory safety:</p>
<ul>
<li><a href="features/kernel.html">Kernel compilation modes</a></li>
<li><a href="features/processes.html">Process environments</a></li>
<li><a href="features/desktop.html">CheriABI desktop environment (experimental)</a></li>
<li><a href="features/temporal.html">Userlevel heap temporal memory safety (experimental)</a></li>
<li><a href="features/c18n.html">Userlevel software compartmentalization (experimental)</a></li>
<li><a href="features/bhyve.html">bhyve hypervisor (experimental)</a></li>
</ul>
<p>Some of these features are in the main CheriBSD branch; other experimental
features remain on development branches.</p>
<h1><a class="header" href="#kernel-compilation-modes" id="kernel-compilation-modes">Kernel compilation modes</a></h1>
<p>The CheriBSD kernel can be compiled either as hybrid or pure-capability code:</p>
<ul>
<li>The <strong>hybrid kernel</strong> enables capability use in userspace while making
relatively little use of capabilities in the kernel's own implementation.</li>
<li>The <strong>pure-capability kernel</strong> implements strong referential and spatial
memory protection internally in the kernel, protecting against memory-safety
vulnerabilities in components such as the network stack and system-call
layer.</li>
</ul>
<h1><a class="header" href="#userlevel-process-environments" id="userlevel-process-environments">Userlevel process environments</a></h1>
<p>CheriBSD 23.11 likewise supports three different userspace execution
environments:</p>
<ul>
<li>
<p><strong>Hybrid processes</strong> provide strong binary compatibility with the non-CHERI
version of the same architecture -- for example, aarch64 on Morello.</p>
</li>
<li>
<p><strong>CheriABI processes</strong> support pure-capability code execution.
This process environment implements strong referential, spatial, and
<a href="features/temporal.html">heap temporal memory protection</a> through the system-call
interface, dynamic linker, language runtime including heap memory
allocators, and compiler-generated code.
This protects against memory memory-safety vulnerabilities in both system
services and applications.
See <a href="features/../helloworld/index.html#building-for-cheriabi">Building for CheriABI</a>
for information on building for CheriABI.
CheriABI is described in an <a href="https://www.cl.cam.ac.uk/research/security/ctsrd/pdfs/201904-asplos-cheriabi.pdf">ASPLOS 2019
paper</a>.</p>
</li>
<li>
<p><strong>Benchmark ABI processes</strong> implement a code-generation model similar to
CheriABI, but with relaxed program-counter capability bounds that enable
improved performance prediction on the Arm Morello platform.
See <a href="features/../helloworld/index.html#building-for-the-benchmark-abi">Building for the Benchmark
ABI</a>.
The Benchmark ABI is described in a <a href="https://ctsrd-cheri.github.io/morello-early-performance-results/cover/index.html">technical report on the topic from
Arm and
Cambridge</a>.</p>
</li>
</ul>
<p>All of these environments can be used over either of the hybrid or
pure-capability kernels.
You can determine the process environment that a particular process is using
via the <code>procstat(1)</code> command, whose default output includes an <code>EMUL</code>
column indicating the process ABI:</p>
<pre><code>% procstat -a
  PID  PPID  PGID   SID  TSID THR LOGIN    WCHAN     EMUL           COMM
...
 3197  3193  3193  3193     0   1 robert   select    FreeBSD ELF64C sshd
 3214  3170  3214  3170  3170   1 robert   select    FreeBSD ELF64  bash
...
</code></pre>
<p>In this example, the <code>sshd</code> daemon is using CheriABI (<code>FreeBSD ELF64C</code>), and
the <code>bash</code> command is using the Hybrid ABI (<code>FreeBSD ELF64</code>).</p>
<p>Pre-compiled third-party software applications (packages) are provided for
each of these ABIs, although CheriABI and Benchmark ABI packages are currently
considered experimental.  This is discussed further in the <a href="features/../packages/">chapter on
packages</a>.</p>
<h1><a class="header" href="#cheriabi-desktop-environment-experimental" id="cheriabi-desktop-environment-experimental">CheriABI desktop environment (experimental)</a></h1>
<p>The installer has the option to install a desktop environment using the Mali
Bifrost GPU on the Morello System-on-Chip.
The option installs a basic desktop environment using KDE and Wayland compiled
for CheriABI with the <code>cheri-desktop</code> package.
It also installs a hybrid ABI Chromium web browser via the
<code>cheri-desktop-hybrid-extras</code> package.</p>
<h1><a class="header" href="#userlevel-heap-temporal-memory-safety-experimental" id="userlevel-heap-temporal-memory-safety-experimental">Userlevel heap temporal memory safety (experimental)</a></h1>
<p>CheriBSD 23.11 incorporates support for userlevel heap temporal memory
safety based on a load-barrier extension to
<a href="https://www.cl.cam.ac.uk/research/security/ctsrd/pdfs/2020oakland-cornucopia.pdf">Cornucopia</a>,
which is inspired by garbage-collection techniques.
A forthcoming paper at ASPLOS 2024 on the Cornucopia Reloaded technique will
describe these differences in detail.</p>
<p>This feature involves a collaboration between the kernel (which provides
asynchronous capability revocation with VM acceleration) and the userlevel
heap allocator (which quarantines freed memory until revocation of any
pointers to it) to ensure that memory cannot be reallocated until there are
no outstanding valid capabilities lasting from its previous allocation.
The userlevel memory allocator and the kernel revoker share an <code>epoch counter</code>
that counts the number of completed atomic revocation sweeps.
Memory added to quarantine in one epoch cannot be removed from quarantine
until at least one complete epoch has passed -- i.e., the epoch counter has
been increased by 2.
More information on temporal memory safety support can be found in the
<a href="https://man.cheribsd.org/cgi-bin/man.cgi/dev/mrs">mrs(3) man page</a>:</p>
<pre><code>man mrs
</code></pre>
<h2><a class="header" href="#checking-whether-temporal-safety-is-globally-enabled" id="checking-whether-temporal-safety-is-globally-enabled">Checking whether temporal safety is globally enabled</a></h2>
<p>Use the <code>sysctl(8)</code> command to inspect the value of the
<code>security.cheri.runtime_revocation_default</code> system MIB entry:</p>
<pre><code>sysctl security.cheri.runtime_revocation_default
</code></pre>
<p>This sysctl sets the default policy for revocation used by processes on
startup.
We recommend setting this in <code>/boot/loader.conf</code>, which is processed by the
boot loader before any user processes start.</p>
<h2><a class="header" href="#controlling-revocation-by-binary-or-process" id="controlling-revocation-by-binary-or-process">Controlling revocation by binary or process</a></h2>
<p>You can forcefully enable or disable revocations for a specific binary or
process
with
<a href="https://man.cheribsd.org/cgi-bin/man.cgi/dev/elfctl">elfctl(1)</a>
or
<a href="https://man.cheribsd.org/cgi-bin/man.cgi/dev/proccontrol">proccontrol(1)</a>
and ignore the default policy:</p>
<pre><code>elfctl -e &lt;+cherirevoke or +nocherirevoke&gt; &lt;binary&gt;
</code></pre>
<pre><code>proccontrol -m cherirevoke -s &lt;enable or disable&gt; &lt;program with arguments&gt;
</code></pre>
<p>You can read more on these commands in the
<a href="https://man.cheribsd.org/cgi-bin/man.cgi/dev/mrs">mrs(3) man page</a>.</p>
<h2><a class="header" href="#synchronous-revocation" id="synchronous-revocation">Synchronous revocation</a></h2>
<p>Revocation normally occurs asynchronously, with a memory quarantine preventing
memory reuse until revocation of any pointers to that memory.
You can insert a specific call in your program to await synchronous
revocation:</p>
<pre><code>malloc_revoke();
</code></pre>
<p>Synchronous revocation on every call to <code>free()</code> can be configured using the
<code>_RUNTIME_REVOCATION_EVERY_FREE_ENABLE</code> environmental variable.</p>
<p>Note that synchronous revocation can incur extremely high expense.</p>
<h2><a class="header" href="#monitoring-revocation-in-processes" id="monitoring-revocation-in-processes">Monitoring revocation in processes</a></h2>
<p>Use the <code>procstat cheri -v</code> command to inspect the CHERI memory-safety state
of a target process.
For example:</p>
<pre><code># procstat cheri -v 923 1012
  PID COMM                C QUAR  RSTATE                              EPOCH
  923 seatd               P  yes    none                                  0
 1012 Xorg                P  yes    none                               0xd2
</code></pre>
<p>Both processes in this example use a pure-capability process environment, have
quarantining enabled, and are not currently revoking.
seatd has never needed to perform a revocation pass, as it remains in epoch 0,
whereas X.org has a non-zero epoch and has performed multiple passes.</p>
<h1><a class="header" href="#userlevel-software-compartmentalization-experimental" id="userlevel-software-compartmentalization-experimental">Userlevel software compartmentalization (experimental)</a></h1>
<p>CheriBSD implements two different
CHERI-enabled software compartmentalization models:</p>
<ul>
<li><strong>Colocated processes (co-processes) compartmentalization</strong> accelerates
UNIX Inter-Process Communication (IPC) and context switching by colocating
multiple processes in the same address space, separating them using CHERI
capabilities.  Support for co-processes is maintained in an experimental
development branch and is not included in current software releases.
For more information see the <a href="https://github.com/CTSRD-CHERI/cheripedia/wiki/Colocation-Tutorial">Colocation Tutorial</a>
wiki page.</li>
<li><strong>Dynamic-linker-based compartmentalization</strong> isolates shared libraries
within a process using CHERI capabilities limiting the access of attackers
who have achieved arbitrary code execution within a library.
The linker-based library compartmentalization model has been included since
the 22.12 release of CheriBSD.
See the <a href="https://man.cheribsd.org/cgi-bin/man.cgi/releng-23.11/c18n">c18n(3) man
page</a>
on an installed system for more information.</li>
</ul>
<h2><a class="header" href="#library-compartmentalization" id="library-compartmentalization">Library compartmentalization</a></h2>
<p>CheriBSD's library compartmentalization feature (c18n) executes each dynamic
library within a compartmentalization-enabled process in its own protection
domain.
The non-default c18n-enabled run-time linker grants libraries capabilities
only to resources (global variables, APIs) declared in their ELF linkage.
Function calls that cross domain boundaries are interposed on by
domain-crossing shims implemented by the run-time linker.</p>
<p>The adversary model for these compartments is one of trusted code but
untrustworthy execution: a library such as <code>libpng</code> or <code>libjpeg</code> is trusted
until it begins dynamic execution -- and has potentially been exposed to
malicious data.
With library compartmentalization, an adversary who achieves arbitrary code
execution within the library at run time will be able to reach only the
resources (and further attack surfaces) declared statically through its
linkage.
The programmer must then harden that linkage, and any involved APIs, to make
them suitable for adversarial engagement -- but the foundation of isolation,
controlled access, and controlled domain transition is provided by the c18n
implementation.</p>
<p>In addition to a modified run-time linker, modest changes have been made to
the aarch64c calling convention to avoid assumptions such as implicit stack
sharing between callers and callees across library boundaries when passing
variadic argument lists.
This modified ABI is now used by all CheriABI binaries in CheriBSD, and so
off-the-shelf aarch64c binaries and libraries can be used with library
compartmentalization without recompilation to the modified ABI.
More information on library compartmentalization can be found in the
<a href="https://man.cheribsd.org/cgi-bin/man.cgi/releng-23.11/c18n">c18n(3) man
page</a>:</p>
<pre><code>man c18n
</code></pre>
<h2><a class="header" href="#compiling-applications-for-library-compartmentalization" id="compiling-applications-for-library-compartmentalization">Compiling applications for library compartmentalization</a></h2>
<p>To compile a main application to use library compartmentalization, add the
following flags to compilation of the program binary:</p>
<pre><code>-Wl,--dynamic-linker=/libexec/ld-elf-c18n.so.1
</code></pre>
<p>For example, compile <code>helloworld.c</code> using:</p>
<pre><code>cc -Wall -g -o helloworld helloworld.c -Wl,--dynamic-linker=/libexec/ld-elf-c18n.so.1
</code></pre>
<p>You can confirm whether a binary uses the c18n run-time linker by inspecting
it using the <code>file</code> command:</p>
<pre><code>file helloworld
</code></pre>
<h2><a class="header" href="#tracing-compartment-boundary-crossings" id="tracing-compartment-boundary-crossings">Tracing compartment-boundary crossings</a></h2>
<p>The BSD ktrace(1) command is able to trace compartment-boundary crossings.
To enable this feature, set the <code>LD_C18N_UTRACE_COMPARTMENT</code> environmental
variable, which will cause the c18n run-time linker to emit records using
the utrace(2) system call.
Run the program under ktrace with the <code>-tu</code> argument to capture only those
records (and not a full system-call trace):</p>
<pre><code>env LD_C18N_UTRACE_COMPARTMENT=1 ktrace -tu ./helloworld
</code></pre>
<p>The resulting <code>ktrace.out</code> file can be viewed using the kdump(1) command:</p>
<pre><code>kdump
</code></pre>
<p>It is important to understand, however, that simply isolating running code is
almost always insufficient to achieve robust sandboxing.
The competent adversary will now consider further rights and attack surfaces
to explore in search of further vulnerabilities.
While this increased work factor of finding additional vulnerabilities is an
important part of compartmentalization, internal software APIs are rarely well
suited to be security boundaries without performing additional hardening.
With this in mind, you can:</p>
<ul>
<li>Inspect the source code, output from <code>objdump</code>, and output from
<code>chericat</code> to assess the robustness of this compartmentalization.
You can install <code>objdump</code> with <code>pkg64 install llvm-base</code> and <code>chericat</code> with <code>pkg64c install chericat</code>.</li>
<li>Consider larger software architectural changes that will allow a library
to be used more robustly when running within a computerment.</li>
</ul>
<p>Library compartmentalization has the potential to significantly improve
software integrity and confidentiality properties in the presence of a strong
adversary.
However, it is also limited by the abstraction being around the current
library operational model.</p>
<h1><a class="header" href="#bhyve-hypervisor-experimental" id="bhyve-hypervisor-experimental">bhyve hypervisor (experimental)</a></h1>
<p>CheriBSD implements, on an experimental development branch, CHERI extensions
to FreeBSD's bhyve Type 2 hypervisor on the Morello architecture.
This allows bhyve to host CHERI-enabled virtual machines, including those
running CheriBSD.</p>
<h1><a class="header" href="#unsupported-freebsd-features" id="unsupported-freebsd-features">Unsupported FreeBSD features</a></h1>
<p>Certain FreeBSD features are currently unavailable in CheriBSD, including:</p>
<ul>
<li>DTrace</li>
</ul>
<p>Many other kernel features are not yet well validated, including:</p>
<ul>
<li>Non-UFS file systems</li>
<li>Most optional modules, such as various firewall systems</li>
</ul>
<h2><a class="header" href="#alpha-zfs-support" id="alpha-zfs-support">Alpha ZFS support</a></h2>
<p>The 23.11 release includes Alpha support for the ZFS file system.  It is
lightly tested, but works without known issues with a hybrid kernel.  With
the pure capability kernel, filesystems can be created and used, but it must
not be the root file system as it currently hangs on boot.</p>
<h2><a class="header" href="#reporting-bugs" id="reporting-bugs">Reporting bugs</a></h2>
<p>Bug reports relating to these under-validated subsystems would be appreciated,
and may be submitted to the <a href="https://github.com/CTSRD-CHERI/cheribsd/issues">CheriBSD GitHub issue
tracker</a>.</p>
<h1><a class="header" href="#getting-cheribsd" id="getting-cheribsd">Getting CheriBSD</a></h1>
<p>CheriBSD can be installed by <a href="getting/../downloading/">downloading</a> or
<a href="getting/../building/">building</a> one of two types of disk images:</p>
<ul>
<li>
<p><strong>Memstick images</strong> that boot and automatically run <code>bsdinstall</code>, the FreeBSD
installer, which can be used to prepare a filesystem on a disk, and then
install CheriBSD onto it.
These will typically be used on Arm Morello boards.</p>
</li>
<li>
<p><strong>Live images</strong> that boot CheriBSD to a login prompt for interactive use.
These will typically be used on instruction-set emulators such as QEMU and
the Arm Morello FVP, as well as on FPGA.</p>
</li>
</ul>
<h1><a class="header" href="#downloading-image-files" id="downloading-image-files">Downloading image files</a></h1>
<p>Memstick and live images can both be downloaded from the <a href="https://www.cheribsd.org/">CheriBSD
website</a>.
Images are compressed using the UNIX <code>xz</code> command, and must be decompressed
before they can be used; for example by running:</p>
<pre><code>unxz cheribsd-memstick-arm64-aarch64c-22.12.img.xz
</code></pre>
<h1><a class="header" href="#building-image-files" id="building-image-files">Building image files</a></h1>
<p>CheriBSD can be built natively on an existing CheriBSD system (e.g., on an Arm
Morello box), and it can also be cross-built from FreeBSD, Linux, and macOS.
Building natively from an ISA-level emulator, such as QEMU, is not recommended
for performance reasons.</p>
<ul>
<li>
<p>Native builds follow the <a href="https://docs.freebsd.org/en/books/handbook/cutting-edge/#makeworld">same build
procedure</a>
as used for the baseline FreeBSD operating system.
Suitable git command-line substitions must be made to use CheriBSD rather
than FreeBSD source code.</p>
</li>
<li>
<p>CheriBSD cross-build orchestration is performed by the Python-based
<a href="https://github.com/CTSRD-CHERI/cheribuild">cheribuild</a> tool, which is
able to build CHERI-enabled toolchain, operating-system stack, and various
applications and other software used by the CHERI project.</p>
</li>
</ul>
<h2><a class="header" href="#key-source-repositories" id="key-source-repositories">Key source repositories</a></h2>
<p>CheriBSD repositories currently reside in the <a href="https://github.com/CTSRD-CHERI">CTSRD-CHERI GitHub
Organization</a>:</p>
<ul>
<li><a href="https://github.com/CTSRD-CHERI/cheribuild">cheribuild GitHub repository</a></li>
<li><a href="https://github.com/CTSRD-CHERI/cheribsd">CheriBSD GitHub repository</a></li>
<li><a href="https://github.com/CTSRD-CHERI/llvm-project">CHERI Clang/LLVM GitHub repository</a></li>
<li><a href="https://github.com/CTSRD-CHERI/gdb">CHERI GDB GitHub repository</a></li>
<li><a href="https://github.com/CTSRD-CHERI/qemu">QEMU-CHERI GitHub repository</a></li>
</ul>
<p>Unless you intend to modify CheriBSD, CHERI Clang/LLVM, CHERI GDB, or
QEMU-CHERI, you should not generally need to manually check out or compile
most of the above repositories.
Instead, existing prebuilt software images/packages should be used, or the
cheribuild command, which will orchestrate software cross-build for you.</p>
<h2><a class="header" href="#checking-out-cheribuild" id="checking-out-cheribuild">Checking out cheribuild</a></h2>
<p><a href="https://github.com/CTSRD-CHERI/cheribuild">cheribuild</a> is a Python-based
build orchestration tool that is the preferred way to cross-build CheriBSD.
It can be checked out from GitHub:</p>
<pre><code>git clone git@github.com:CTSRD-CHERI/cheribuild.git
</code></pre>
<h2><a class="header" href="#building-and-running-cheribsdrisc-v-in-qemu" id="building-and-running-cheribsdrisc-v-in-qemu">Building and running CheriBSD/RISC-V in QEMU</a></h2>
<p>The following command builds a CheriBSD/RISC-V live image, and boots it in
QEMU-CHERI:</p>
<pre><code>% ./cheribuild.py -d build-and-run-cheribsd-riscv64-purecap
</code></pre>
<h2><a class="header" href="#building-and-running-cheribsdmorello-in-qemu" id="building-and-running-cheribsdmorello-in-qemu">Building and running CheriBSD/Morello in QEMU</a></h2>
<p>The following command builds a CheriBSD/Morello live image, and boots it in
QEMU-CHERI:</p>
<pre><code>% ./cheribuild.py -d build-and-run-cheribsd-morello-purecap
</code></pre>
<h2><a class="header" href="#building-cheribsdmorello-release-images" id="building-cheribsdmorello-release-images">Building CheriBSD/Morello release images</a></h2>
<p>The following command builds a CheriBSD/Morello installer (memstick) image
suitable to write to a USB stick:</p>
<pre><code>% ./cheribuild.py -d --clean cheribsd-release-morello-purecap
</code></pre>
<p>The resulting image file will be generated in a file with a name along the
lines of:
<code>output/cheribsd-release-morello-purecap/FreeBSD-14.0-CURRENT-arm64-aarch64c-memstick.img</code>.
This is relative to your <code>cheribuild</code> destination root, which is, by default,
<code>~/cheri</code>.</p>
<h2><a class="header" href="#obtaining-further-information" id="obtaining-further-information">Obtaining further information</a></h2>
<p>The <code>cheribuild</code> <a href="https://github.com/CTSRD-CHERI/cheribuild#readme">README.md</a>
provides detailed information on various parameters and targets its supports,
as well as its dependencies.</p>
<h1><a class="header" href="#cheribsd-on-an-arm-morello-board" id="cheribsd-on-an-arm-morello-board">CheriBSD on an Arm Morello board</a></h1>
<p>Arm's Morello board contains a quadcore CHERI-extended Neoverse N1 processor
design, as well as two management microcontrollers.
CheriBSD is able to run on, and fully utilize, Morello's CHERI support to
implement fine-grained kernel and userspace memory safety, and on experimental
branches, also implement scalable software compartmentalization.
You can install CheriBSD into the hard disk in your Morello box using a USB
stick installer image.
You will first need to upgrade the firmware, as older firmware revisions
contain bugs or lack features essential to running the OS.
This chapter explains how to:</p>
<ul>
<li>Connect to the Morello management and system consoles via USB,</li>
<li>Upgrade the board's firmware, and</li>
<li>Install CheriBSD from a USB stick.</li>
</ul>
<p>It is also possible to run CheriBSD from a USB stick, or netboot CheriBSD on
the board, but those topics are not currently covered by this guide.</p>
<p><strong>It is important that the most recent Arm-provided firmware be installed on
your Morello board, as the board has most likely shipped with an older
firmware version.
If you are not running the latest version, you may experience hard-to-diagnose
behaviour or reliability problems.</strong></p>
<h1><a class="header" href="#accessing-the-morello-console" id="accessing-the-morello-console">Accessing the Morello console</a></h1>
<p>You can manage the Morello board, including reaching its multiple serial
consoles and firmware flash storage, via a USB cable connected to a second
computer -- typically a workstation or remote management server.
When you plug the USB cable into your workstation, a number of different
devices will attach (depending on device drivers on your workstation),
including:</p>
<ul>
<li>Arm Morello USB debug and trace</li>
<li>Flash storage used for firmware (an on-board SD card)</li>
<li>Two 4-port USB-to-serial converters</li>
</ul>
<p>Each controller has a unique serial number ending in the letter &quot;A&quot; or B&quot;.
The serial-port converters attach to UARTs associated with:</p>
<ul>
<li>The MCC management microcontroller (converter B port 0)</li>
<li>The PCC management microcontroller (converter B port 1)</li>
<li>The Morello system console (converter B port 2)</li>
</ul>
<p>In normal use, only the MCC and Morello system console ports will be used.
You can connect to these using a serial access tool such as cu(1), or a full
terminal emulation environment such as screen(1).
The precise names of the <code>/dev</code> device nodes appearing on the workstation
depend on the operating system being used.
Often access will also require running the terminal command under su(8) or
sudo(8), or adding your user to a <code>dialer</code> or similar group to grant access to
the USB device nodes.</p>
<h2><a class="header" href="#connecting-from-freebsd" id="connecting-from-freebsd">Connecting from FreeBSD</a></h2>
<p>FreeBSD names USB device nodes in the order they probe and attach.
Typical command lines to access the MCC and Morello consoles are:</p>
<ul>
<li>MCC console: <code>cu -l /dev/cuaU0 -s 115200</code></li>
<li>Morello console: <code>cu -l /dev/cuaU2 -s 115200</code></li>
</ul>
<h2><a class="header" href="#connecting-from-apple-macos" id="connecting-from-apple-macos">Connecting from Apple macOS</a></h2>
<p>macOS creates <code>/dev/cu.usbserial-</code> device nodes that embed the device
serial number (including <code>A</code> or <code>B</code>) and port number.
Typical command lines to access the MCC and Morello consoles are:</p>
<ul>
<li>MCC console: <code>cu -l /dev/cu.usbserial-00FT41683097B0 -s 115200</code></li>
<li>Morello console: <code>cu -l /dev/cu.usbserial-00FT41683097B2 -s 115200</code></li>
</ul>
<p>You will need to substitute the serial numbers of the USB converters in your
specific Morello board for these commands to work.</p>
<h1><a class="header" href="#upgrading-the-morello-firmware" id="upgrading-the-morello-firmware">Upgrading the Morello firmware</a></h1>
<p>Newer Morello firmware versions contain important feature extensions (such as
support for network booting) and also bug fixes (such as persistent variable
support for UEFI, which is relied on for CheriBSD boot).</p>
<p>More detailed information from Arm on Morello firmware builds and
configuration can be found
<a href="https://developer.arm.com/documentation/den0132/0100/Flash-the-onboard-SD-card">here</a>.
The instructions in this guide are an abbreviated and slightly modified set of
instructions better tuned to CheriBSD requirements.</p>
<h2><a class="header" href="#setting-the-system-clock" id="setting-the-system-clock">Setting the system clock</a></h2>
<p>Start by setting the system date and time in the MCC.
Although the Arm documentation recommends setting your local time, we
recommend using UTC with CheriBSD:</p>
<pre><code>Cmd&gt; debug
Debug&gt; time
Debug&gt; date
Debug&gt; exit
</code></pre>
<h2><a class="header" href="#downloading-prebuilt-firmware" id="downloading-prebuilt-firmware">Downloading prebuilt firmware</a></h2>
<p>Arm provides <a href="https://git.morello-project.org/morello/board-firmware">prebuilt firmware
images</a> via the
Morello GitLab instance, although you can also build your own.
Start by downloading this directory tree, which can be done by performing a
<code>git clone</code>:</p>
<pre><code>git clone https://git.morello-project.org/morello/board-firmware.git
</code></pre>
<h2><a class="header" href="#reflashing-the-firmware" id="reflashing-the-firmware">Reflashing the firmware</a></h2>
<p>The Morello firmware is stored on a 2.0GiB SD Card on the Morello board within
the case.
The SD Card content can be exposed as a USB mass storage device accessible
over the USB cable from your workstation.
This may require first enabling USB support on the MCC console:</p>
<pre><code>Cmd&gt; USB_ON
Enabling debug USB...
</code></pre>
<p>The SD Card will attach as a USB disk containing a FAT filesystem.
Depending on your workstation operating system, this may be automatically
mounted (e.g., on macOS), or require manual mounting (e.g., on FreeBSD).
Once mounted, delete the existing firmware and configuration, and then copy on
the new version (substituting an appropriate mounted directory for <code>/mnt</code>
below):</p>
<pre><code>rm -rf /mnt/*
cp -R board-firmware/* /mnt
sync
</code></pre>
<p>Depending on your workstation OS and configuration, you may need to run as
root, or use sudo(8), to execute these commands.
Some shells may require confirmation before they will complete the <code>rm</code>
command.</p>
<p><strong>When done, you must unmount the mounted filesystem to ensure that all blocks
in your workstation's filesystem buffer cache have been written back, and to
avoid concurrent accesses leading to possible filesystem corruption.
This must be done before issuing the MCC <code>reboot</code> command.</strong></p>
<h2><a class="header" href="#rebooting-the-mcc" id="rebooting-the-mcc">Rebooting the MCC</a></h2>
<p>Complete the upgrade by rebooting the Morello board via the MCC:</p>
<pre><code>Cmd&gt; reboot
Rebooting...
Disabling debug USB..
</code></pre>
<h2><a class="header" href="#recovering-the-sd-card-format" id="recovering-the-sd-card-format">Recovering the SD Card format</a></h2>
<p>If you find that your SD Card no longer has a correct partition table
(for example, if like the author you have written an installer image
over it by accident) you will need to restore it to the original state
with a FAT formated volume named M1SDP. The mechanism for creating
such a filesystem will vary by OS. After you have created the FAT
filesystem, follow the instruction above to copy the firmware into place
and install it.</p>
<h3><a class="header" href="#linux" id="linux">Linux</a></h3>
<p>On Linux the following commands will create and format the FAT32 partition:</p>
<pre><code>parted /dev/sdX mktable msdos
parted /dev/sdX mkpart primary fat32 0% 100%
mkfs.msdos /dev/sdX1
</code></pre>
<p>In this command <code>/dev/sdX</code> should be replaced by the path to the SD Card
device.</p>
<h3><a class="header" href="#macos" id="macos">MacOS</a></h3>
<p>On MacOS the following command will create and format the M1SDP partition:</p>
<pre><code>diskutil partitionDisk /dev/disk# 1 MBRFormat MS-DOS M1SDP 100%
</code></pre>
<p>In this command <code>/dev/disk#</code> should be replaced by the path to the SD Card
device.</p>
<h1><a class="header" href="#installing-on-a-morello-board" id="installing-on-a-morello-board">Installing on a Morello Board</a></h1>
<p><em><strong>Please ensure that you have upgraded the Morello board firmware before
proceeding to CheriBSD installation.</strong></em></p>
<p>Once you have a disk image, you will either need to write it to a USB stick
to boot an Arm Morello system, or specify it as an argument to an emulator
such as QEMU-CHERI or the Arm Morello FVP.</p>
<h2><a class="header" href="#writing-an-installer-disk-image-to-a-usb-stick" id="writing-an-installer-disk-image-to-a-usb-stick">Writing an installer disk image to a USB stick</a></h2>
<p>With appropriate substitutions of image filename and target device, the
following command would write the image to a USB stick for use with a Morello
board:</p>
<pre><code>dd if=cheribsd-memstick-arm64-aarch64c-23.11.img of=/dev/DISK bs=1M
</code></pre>
<p>It is also possible to write a live image to a USB stick, with appropriate
filename substitution.</p>
<h2><a class="header" href="#installing-an-arm-morello-system" id="installing-an-arm-morello-system">Installing an Arm Morello system</a></h2>
<p>It is possible to use Arm Morello systems both by booting the live image on a
USB stick, and also by installing to the internal hard disk.
In this section, we describe the how to perform an installation using the
memstick image.</p>
<h3><a class="header" href="#starting-the-boot" id="starting-the-boot">Starting the boot</a></h3>
<p>Before powering on your Morello board, ensure that the installer USB stick is
inserted into one of the USB ports on the board.
Use the power switch to power the board on, which should lead to firmware
output on the MCC console during a multi-minute initialization and boot cycle.</p>
<p>Once that has completed, you will see Morello firmware output on the Morello
console.
When this message is presented, press Escape to enter the UEFI boot menu:</p>
<pre><code>Press ESCAPE for boot options .......
</code></pre>
<p>At the UEFI menu, select Boot Manager using the cursor keys, and press
Enter:</p>
<pre><code>   Select Language            &lt;Standard English&gt;         This selection will
                                                         take you to the
 &gt; Device Manager                                        Device Manager
 &gt; Boot Manager
 &gt; Boot Maintenance Manager

   Continue
   Reset







  ^v=Move Highlight       &lt;Enter&gt;=Select Entry
</code></pre>
<p>Select your USB stick from the Boot Manager menu using the cursor keys, and
press enter.
In the example below, it is the SanDisk Ultra USB 3.0 device:</p>
<pre><code>/------------------------------------------------------------------------------\
|                                Boot Manager                                  |
\------------------------------------------------------------------------------/

                                                         Device Path :
   Boot Manager Menu                                     PcieRoot(0x0)/Pci(0x0,
                                                         0x0)/Pci(0x0,0x0)/Pci(
   UEFI Shell                                            0x14,0x0)/Pci(0x0,0x0)
   UEFI Misc Device                                      /USB(0x5,0x0)
   UEFI WDC WDS240G2G0A-00JH30 2143B2455605
   UEFI PXEv4 (MAC:0002F7009856)
   UEFI HTTPv4 (MAC:0002F7009856)
   UEFI HTTPv6 (MAC:0002F7009856)
   UEFI PXEv6 (MAC:0002F7009856)
   UEFI SanDisk Ultra USB 3.0
   0101cfbb32adfd6c145cd38e7d6164cd167456963c3a71b9f157
   e574567b43d96c6000000000000000000000e49dde42009f1a00
   955581079e275d95
   UEFI Non-Block Boot Device
                                                       v
/------------------------------------------------------------------------------\
|                                                                              |
| ^v=Move Highlight       &lt;Enter&gt;=Select Entry      Esc=Exit                   |
\------------------------------------------------------------------------------/
</code></pre>
<p>This will be followed by the CheriBSD boot loader and kernel output.
You can press Enter to proceed, or wait for the countdown timer to finish:</p>
<pre><code>    _____ _               _ ____   _____ _____
   / ____| |             (_)  _ \ / ____|  __ \
  | |    | |__   ___ _ __ _| |_) | (___ | |  | |
  | |    | '_ \ / _ \ '__| |  _ &lt; \___ \| |  | |
  | |____| | | |  __/ |  | | |_) |____) | |__| |
   \_____|_| |_|\___|_|  |_|____/|_____/|_____/
                                                 ```                        `
                                                s` `.....---.......--.```   -/
 /---------- Welcome to CheriBSD ----------\    +o   .--`         /y:`      +.
 |                                         |     yo`:.            :o      `+-
 |  1. Boot Installer [Enter]              |      y/               -/`   -o/
 |  2. Boot Single user                    |     .-                  ::/sy+:.
 |  3. Escape to loader prompt             |     /                     `--  /
 |  4. Reboot                              |    `:                          :`
 |  5. Cons: Serial                        |    `:                          :`
 |                                         |     /                          /
 |  Options:                               |     .-                        -.
 |  6. Kernel: default/kernel (1 of 1)     |      --                      -.
 |  7. Boot Options                        |       `:`                  `:`
 |                                         |         .--             `--.
 |                                         |            .---.....----.
 \-----------------------------------------/
   Autoboot in 10 seconds. [Space] to pause
</code></pre>
<p>Note that seperate instances of the installer will run on both the video and
serial consoles.  Care should be taken to ensure that only one is used as
no mechanism is implemented to prevent one from destroying the other's work.</p>
<p>On the serial console, you will eventually be prompted to select a terminal
emulation type:</p>
<pre><code>Welcome to FreeBSD!

Please choose the appropriate terminal type for your system.
Common console types are:
   ansi     Standard ANSI terminal
   vt100    VT100 or compatible terminal
   xterm    xterm terminal emulator (or compatible)

Console type [xterm]:
</code></pre>
<p>In most cases, simply hitting Enter will be the right thing to do.
This will enter <code>bsdinstall</code>, the interactive FreeBSD installer.</p>
<h3><a class="header" href="#bsdinstall" id="bsdinstall">bsdinstall</a></h3>
<p><code>bsdinstall</code> uses the <code>libdialog</code> text interface library.
<strong>Be aware that you will sometimes need to use the space bar, and not enter
key, to select menu options, which many users find confusing.</strong></p>
<p>Select <strong>Install</strong> at the first menu by hitting Enter:</p>
<pre><code>                     Welcome
                      Welcome to FreeBSD! Would you   
                      like to begin an installation   
                      or use the live CD?             
                     
                      &lt;Install&gt; &lt; Shell &gt; &lt;Live CD&gt;   
                     
</code></pre>
<h4><a class="header" href="#keymap-selection" id="keymap-selection">Keymap selection</a></h4>
<p>If you intend only to use the serial console, and not video console, select
the default keymap by hitting Enter at the next menu; otherwise, use the
cursor keys and space bar to select a country-specific keyboard layout:</p>
<pre><code>     Keymap Selection
      The system console driver for FreeBSD defaults to standard &quot;US&quot; 
      keyboard map. Other keymaps can be chosen below.                
       
      &gt;&gt;&gt; Continue with default keymap                              
      -&gt;- Test default keymap                                       
      ( ) Armenian phonetic layout                                  
      ( ) Belarusian                                                
      ( ) Belgian                                                   
      ( ) Belgian (accent keys)                                     
      ( ) Brazilian (accent keys)                                   
      ( ) Brazilian (without accent keys)                           
      ( ) Bulgarian (BDS)                                           
      ( ) Bulgarian (Phonetic)                                      
      ( ) Canadian Bilingual                                        
      (+)12% 
     
                        &lt;Select&gt;          &lt;Cancel&gt;                    
     [Press arrows, TAB or ENTER]
</code></pre>
<h4><a class="header" href="#hostname" id="hostname">Hostname</a></h4>
<p>Press Enter to accept the default hostname, or replace it:</p>
<pre><code>           Set Hostname
            Please choose a hostname for this machine.          
                                                                
            If you are running on a managed network, please ask 
            your network administrator for an appropriate name. 
             
            cheribsd                                          
             
           
                                &lt;  OK  &gt;                        
           
</code></pre>
<h4><a class="header" href="#partitioning-automatic-or-manual" id="partitioning-automatic-or-manual">Partitioning (automatic or manual)</a></h4>
<p>This tutorial assumes that you are performing a fresh install, or a complete
reinstall of your Morello system, with the intention of booting only CheriBSD.
It also assumes that you will be using the UFS file system.
If these assumpsions are not true, read the FreeBSD documentation for more
information on partitioning disks before proceeding.</p>
<p>Press Enter to select an automated UFS install:</p>
<pre><code>          Partitioning
           How would you like to partition your disk?             
            
              Auto (UFS)  Guided UFS Disk Setup                 
              Auto (ZFS)  EXPERIMENTAL Guided Root-on-ZFS       
              Manual      Manual Disk Setup (experts)           
              Shell       Open a shell and partition by hand    
                                                                
                                                                
            
          
                         &lt;  OK  &gt;        &lt;Cancel&gt;                 
          
</code></pre>
<h4><a class="header" href="#partition-entire-disk" id="partition-entire-disk">Partition (entire disk)</a></h4>
<p>Select Entire Disk and press Enter:</p>
<pre><code>                 Partition
                  Would you like to use this entire disk   
                  (ada0) for FreeBSD or partition it to    
                  share it with other operating systems?   
                  Using the entire disk will erase any     
                  data currently stored there.             
                 
                      &lt;Entire Disk&gt;   &lt; Partition &gt;        
                 
</code></pre>
<h4><a class="header" href="#partition-entire-disk---confirmation" id="partition-entire-disk---confirmation">Partition (entire disk - confirmation)</a></h4>
<p>Press Enter to confirm:</p>
<pre><code>                 Partition
                  WouldConfirmationdisk   
                  (ada0 This will erase the disk.   o    
                  share Are you sure you want to    s?   
                  Using proceed?                         
                  data        
                      &lt; Yes &gt;   &lt; No  &gt;       
                      &lt;       
                                              
</code></pre>
<h4><a class="header" href="#partition-editor" id="partition-editor">Partition Editor</a></h4>
<p>Review the proposed partition scheme, select Finish, and then press Enter to
proceed:</p>
<pre><code>           Partition Editor
            Please review the disk setup. When complete, press   
            the Finish button.                                   
           
           ada0            224 GB  GPT                         
             ada0p1        260 MB  efi            /boot/efi    
             ada0p2        220 GB  freebsd-ufs    /            
             ada0p3        3.6 GB  freebsd-swap   none         
           da0             57 GB   GPT                         
             da0p1         33 MB   efi                         
             da0p2         2.4 GB  freebsd-ufs                 
                                                               
           
           
           &lt;Create&gt; &lt;Delete&gt; &lt;Modify&gt; &lt;Revert&gt; &lt; Auto &gt; &lt;Finish&gt; 
           
</code></pre>
<h4><a class="header" href="#partition-editor---confirmation" id="partition-editor---confirmation">Partition editor - confirmation</a></h4>
<p>Select Commit and press Enter to continue with writing out a new partition
table:</p>
<pre><code>            Partition Editor
             Please review the disk setup. When complete, press  
             the Finish button.                                  
                                                                 
                                                                 
              
             Confirmation 
              Your changes will now be written to disk. If    
              you have chosen to overwrite existing data,     
              it will be PERMANENTLY ERASED. Are you sure     
              you want to commit your changes?                
               
             [   Commit    ] [Revert &amp; Exit] [    Back     ]  
               
                                                                
                                                               
              
            
            [Create] [Delete] [Modify] [Revert] [ Auto ] [Finish]
            
</code></pre>
<h4><a class="header" href="#the-installation-proceeds" id="the-installation-proceeds">The installation proceeds</a></h4>
<p>The installer will now proceed to check distribution files and unpack them
onto the disk.
Unless something goes wrong, no user interaction is required.
Typical output from the installation process will look like this:</p>
<pre><code> FreeBSD Installer
 
Checksum Verification
 base.txz                                                   [   Passed    ] 
 kernel.txz                                                 [   Passed    ] 
 base-dbg.txz                                               [   Passed    ] 
 kernel-dbg.txz                                             [   Passed    ] 
 kernel.GENERIC-MORELLO-NOCAPREVOKE-NODEBUG-dbg.txz         [   Passed    ] 
 kernel.GENERIC-MORELLO-NOCAPREVOKE-NODEBUG.txz             [   Passed    ] 
 kernel.GENERIC-MORELLO-NOCAPREVOKE-dbg.txz                 [ In Progress ] 
 kernel.GENERIC-MORELLO-NOCAPREVOKE.txz                     [   Pending   ] 
 kernel.GENERIC-MORELLO-NODEBUG-dbg.txz                     [   Pending   ] 
 kernel.GENERIC-MORELLO-NODEBUG.txz                         [   Pending   ] 
 kernel.GENERIC-MORELLO-PURECAP-NOCAPREVOKE-NODEBUG-dbg...  [   Pending   ] 
 kernel.GENERIC-MORELLO-PURECAP-NOCAPREVOKE-NODEBUG.txz     [   Pending   ] 
 ...                                                                        
                                                                            
 Verifying checksums of selected distributions.                             
                                                                            
  Overall Progress  
                                    24%                                   
    

</code></pre>
<h4><a class="header" href="#updating-the-efi-configuration-table" id="updating-the-efi-configuration-table">Updating the EFI configuration table</a></h4>
<p>If you are reinstalling a Morello box with an existing OS install, you may be
prompted to update the boot configuration.
Press Enter to proceed:</p>
<pre><code>                      Boot Configuration
                       There are multiple &quot;FreeBSD&quot;  
                       EFI boot entries. Would you   
                       like to remove them all and   
                       add a new one?                
                      
                           &lt; Yes &gt;   &lt; No  &gt;         
                      
</code></pre>
<h4><a class="header" href="#setting-a-root-password" id="setting-a-root-password">Setting a root password</a></h4>
<p>Enter a new root password and press Enter.
Then confirm it by typing the same password again and pressing Enter.</p>
<pre><code>Please select a password for the system management account (root):
Typed characters will not be visible.
Changing local password for root
New Password:
</code></pre>
<h4><a class="header" href="#network-configuration" id="network-configuration">Network configuration</a></h4>
<p>If desired, configure Ethernet networking by pressing Enter.</p>
<pre><code>      Network Configuration
       Please select a network interface to configure:                 
        
       re0 RealTek 8168/8111 B/C/CP/D/DP/E/F/G PCIe Gigabit Ethernet 
        
      
                            [  OK  ]     [Cancel]                      
      
</code></pre>
<h4><a class="header" href="#network-configuration---enabling-ipv4" id="network-configuration---enabling-ipv4">Network configuration - enabling IPv4</a></h4>
<p>If desired, enable IPv4 on the Ethernet interface by selecting Yes and
pressing Enter:</p>
<pre><code>                        Network Configuration
                         Would you like to         
                         configure IPv4 for this   
                         interface?                
                        
                             &lt; Yes &gt;   &lt; No  &gt;     
                        
</code></pre>
<h4><a class="header" href="#network-configuration---dhcp-for-ipv4" id="network-configuration---dhcp-for-ipv4">Network configuration - DHCP for IPv4</a></h4>
<p>If you will be using DHCP, select Yes and press Enter.
Otherwise select No and press Enter to perform a manual IPv4 configuration.</p>
<pre><code>                       Network Configuration
                        Would you like to use DHCP   
                        to configure this interface? 
                       
                            [ Yes  ]    [  No  ]     
                       
</code></pre>
<h4><a class="header" href="#network-configuration---enabling-ipv6" id="network-configuration---enabling-ipv6">Network configuration - enabling IPv6</a></h4>
<p>If desired, enable IPv6 on the Ethernet interface by selecting Yes and
pressing Enter:</p>
<pre><code>                        Network Configuration
                         Would you like to configure 
                         IPv6 for this interface?    
                        
                            [ Yes  ]    [  No  ]     
                        
</code></pre>
<h4><a class="header" href="#network-configuration---slaac-for-ipv6" id="network-configuration---slaac-for-ipv6">Network configuration - SLAAC for IPv6</a></h4>
<p>Press Enter to use stateless address autoconfiguration for IPv6:</p>
<pre><code>                      Network Configuration
                       Would you like to try stateless 
                       address autoconfiguration       
                       (SLAAC)?                        
                      
                            [ Yes  ]     [  No  ]      
                      
</code></pre>
<h4><a class="header" href="#network-configuration---resolver-configuration" id="network-configuration---resolver-configuration">Network configuration - resolver configuration</a></h4>
<p>Enter DNS resolution configuration information, or press Enter to confirm
autoconfigured DNS configuration:</p>
<pre><code>   Network Configuration
    Resolver Configuration                                               
     
    Search                                                             
    IPv6 DNS #1                                                        
    IPv6 DNS #2                                                        
    IPv4 DNS #1    192.168.4.1                                         
    IPv4 DNS #2                                                        
     
   
                        &lt;  OK  &gt;           &lt;Cancel&gt;                      
   
</code></pre>
<h4><a class="header" href="#local-or-utc-clock" id="local-or-utc-clock">Local or UTC clock</a></h4>
<p>Press Enter to select a system clock on UTC:</p>
<pre><code>   Select local or UTC (Greenwich Mean Time) clock
    Is this machine's CMOS clock set to UTC?  If it is set to local time, 
    or you don't know, please choose NO here!                             
                                                                          
   
                             [ Yes  ]   [  No  ]                          
   
</code></pre>
<h4><a class="header" href="#timezone-selection" id="timezone-selection">Timezone selection</a></h4>
<p>Press Enter to select UTC as your timezone; otherwise, select your continent
and press Enter.</p>
<pre><code>                      Time Zone Selector
                       Select a region                 
                        
                       0  UTC                        
                       1  Africa                     
                       2  America -- North and South 
                       3  Antarctica                 
                       4  Arctic Ocean               
                       5  Asia                       
                       6  Atlantic Ocean             
                       7  Australia                  
                       8  Europe                     
                       9  Indian Ocean               
                       10 Pacific Ocean              
                        
                      
                            [  OK  ]     [Cancel]      
                      
</code></pre>
<p>If you have not selected UTC, select your country and press Enter:</p>
<pre><code>        Countries in Europe
         Select a country or region                                  
         ^^^ 
          35 Poland                                                
          36 Portugal                                              
          37 Romania                                               
          38 Russian Federation                                    
          39 San Marino                                            
          40 Serbia                                                
          41 Slovakia                                              
          42 Slovenia                                              
          43 Spain                                                 
          44 Svalbard and Jan Mayen                                
          45 Sweden                                                
          46 Switzerland                                           
          47 Turkey                                                
          48 Ukraine                                               
          49 United Kingdom of Great Britain and Northern Ireland  
          50 land Islands                                         
         100% 
        
                             [  OK  ]   [Cancel]                     
        
</code></pre>
<p>Confirm your choice by selecting Yes and pressing Enter:</p>
<pre><code>   Confirmation
    Does the abbreviation `UTC' look reasonable?                         
   
                            [ Yes  ]     [  No  ]                        
   
</code></pre>
<h4><a class="header" href="#setting-the-date-and-time" id="setting-the-date-and-time">Setting the date and time</a></h4>
<p>As desired, set the date, or select Skip and press Enter if you plan
to use network time synchronization:</p>
<pre><code>                   Time &amp; Date
                                    
                           2023/ December/15       
                                    
                   
                          [Set Date]     [  Skip  ]      
                   
</code></pre>
<p>And, likewise, the time:</p>
<pre><code>                   Time &amp; Date
                                             
                               11:23:20            
                                             
                   
                          [Set Time]     [  Skip  ]      
                   
</code></pre>
<h4><a class="header" href="#system-configuration" id="system-configuration">System configuration</a></h4>
<p>As desired, enable any further services (e.g., <code>ntpd</code> and <code>ntpdate</code>) by
selecting them and hitting Space:</p>
<pre><code>System Configuration
 Choose the services you would like to be started at boot:                  
  
 [ ] local_unbound      Local caching validating resolver                 
 [X] sshd               Secure shell daemon                               
 [ ] moused             PS/2 mouse pointer on console                     
 [ ] ntpd               Synchronize system and network time               
 [ ] ntpd_sync_on_start Sync time on ntpd startup, even if offset is high 
 [ ] powerd             Adjust CPU frequency dynamically if supported     
 [X] dumpdev            Enable kernel crash dumps to /var/crash           
 [ ] debugger_on_panic  Run debugger on kernel panic                      
  

                                  [  OK  ]                                  

</code></pre>
<p>Then press Enter to continue.</p>
<h4><a class="header" href="#add-user-accounts" id="add-user-accounts">Add user accounts</a></h4>
<p>If you plan to install the desktop environment in the next step, it is
useful to create user accounts now.
If desired, select Yes and press Enter to add non-root accounts.
Otherwise, select No and press Enter</p>
<pre><code>                        Add User Accounts
                         Would you like to add     
                         users to the installed    
                         system now?               
                        
                             &lt; Yes &gt;   &lt; No  &gt;     
                        
</code></pre>
<p>If you add non-root users, we recommend adding them to the <code>wheel</code>,
<code>operator</code>, and <code>video</code> groups to allow them to manage the system as well as
use the desktop environment.</p>
<h4><a class="header" href="#cheri-desktop-environment" id="cheri-desktop-environment">CHERI Desktop environment</a></h4>
<p>If you wish to configure your CheriBSD system with a KDE-based desktop
environment you can do so now.  <strong>NOTE: You must have previously
configured the network and be able to reach pkg.CheriBSD.org.</strong></p>
<pre><code>                      CHERI Desktop
                       Would you like to install the  
                       CHERI desktop environment      
                       (requires network)?            
                      
                            [ Yes  ]     [  No  ]     
                      
</code></pre>
<p>Select Yes to install (<strong>NOTE: this may take 20-50 minutes depending on
network conditions</strong>).</p>
<h4><a class="header" href="#virtualization-support" id="virtualization-support">Virtualization support</a></h4>
<p>If you wish to configure your CheriBSD system to support <code>bhyve</code>-based,
CHERI-enabled virtual machines, press Enter:</p>
<pre><code>                      CHERI VM Support
                       Would you like to install CHERI 
                       virtual machine support         
                       (requires network)?             
                      
                            [ Yes  ]     [  No  ]      
                      
</code></pre>
<h4><a class="header" href="#final-configuration" id="final-configuration">Final configuration</a></h4>
<p>If there are further configuration settings to change, select an appropriate
option from the menu and press Space.
Otherwise, press Enter to complete the installation:</p>
<pre><code>Final Configuration
 Setup of your FreeBSD system is nearly complete. You can now modify your   
 configuration choices. After this screen, you will have an opportunity to  
 make more complex changes using a shell.                                   
  
 Exit              Apply configuration and exit installer                 
 Add User          Add a user to the system                               
 Root Password     Change root password                                   
 Hostname          Set system hostname                                    
 Network           Networking configuration                               
 Services          Set daemons to run on startup                          
 System Hardening  Set security options                                   
 Time Zone         Set system timezone                                    
 Handbook          Install FreeBSD Handbook (requires network)            
 CHERI Desktop     Install the CHERI desktop environment (requires networ 
 CHERI VM Support  Install CHERI virtual machine support (requires networ 
                                                                          
                                                                          
                                                                          
  

                                 &lt;  OK  &gt;                                   

</code></pre>
<h4><a class="header" href="#manual-configuration" id="manual-configuration">Manual configuration</a></h4>
<p>If desired, select Yes and press Enter to drop to a shell before reboot.
Otherwise, select No and press Enter.</p>
<pre><code>                   Manual Configuration
                    The installation is now finished.   
                    Before exiting the installer, would 
                    you like to open a shell in the new 
                    system to make any final manual     
                    modifications?                      
                   
                            &lt; Yes &gt;     &lt; No  &gt;         
                   
</code></pre>
<h3><a class="header" href="#complete" id="complete">Complete</a></h3>
<p>Select Reboot and press Enter:</p>
<pre><code>                     Complete
                      Installation of FreeBSD complete! 
                      Would you like to reboot into the 
                      installed system now?             
                     
                      [ Reboot ] [Shutdown] [Live CD ]  
                     
</code></pre>
<h3><a class="header" href="#rebooting-after-installation" id="rebooting-after-installation">Rebooting after installation</a></h3>
<p>Remove the USB stick to prevent the installer from running after a system
reboot.
If you have issues with reliabity rebooting your Morello box, confirm that you
are using a recent Morello firmware revision due to <a href="morello-install/../morello-issues/">a known firmware
bug</a> in earlier versions that made OS-triggered reboot
unreliable.</p>
<h3><a class="header" href="#logging-in" id="logging-in">Logging in</a></h3>
<p>Log in using the username <code>root</code> and the password you entered during the
installation process:</p>
<pre><code>...
Performing sanity check on sshd configuration.
Starting sshd.
Starting cron.
Starting background file system checks in 60 seconds.
Starting sddm.

Fri Dec 15 11:32:45 UTC
CheriBSD/arm64 (cheribsd) (ttyu0)

login: root
Password:
Dec 15 11:37:01 cheribsd login[1277]: ROOT LOGIN (root) ON ttyu0
FreeBSD 14.0-CURRENT aarch64c 1400094 (GENERIC-MORELLO) #0 releng/23.11-3b754ceed4ae: Wed Dec 13 08:54:18 UTC 2023

Welcome to CheriBSD!

CheriBSD extends FreeBSD to implement memory protection and software
compartmentalization features enabled by CHERI-extended CPUs.

The CheriBSD front page:
  https://www.cheribsd.org/

We provide support via a mailing list:
  https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-lists.html

And also via the CHERI-CPU Slack:
  https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-slack.html

CheriBSD source may be found at:
  https://github.com/CTSRD-CHERI/cheribsd/

Find out more about about CHERI at https://cheri-cpu.org/

WARNING: INVARIANTS kernel option defined, expect reduced performance
WARNING: WITNESS kernel option defined, expect reduced performance
WARNING: capability revocation enabled by default, this may affect performance
root@cheribsd:~ #
</code></pre>
<p>You can now add further users, install SSH keys for remote access, install
packages, and so on.</p>
<h1><a class="header" href="#morello-known-issues" id="morello-known-issues">Morello known issues</a></h1>
<p>The following known issues may affect the reliability and usability of
CheriBSD on Morello:</p>
<ul>
<li>
<p>If a USB hub is plugged in (including embedded hubs in USB keyboards) the
system will pause on boot due to a firmware bug.  Some people find they
can bypass this pause by pressing Enter on a USB keyboard attached to
the Morello desktop system.  Others find they must unplug the hub to boot.</p>
</li>
<li>
<p>Sometimes the ATA controller starts timing out. and displaying messages
like this on the console:</p>
<pre><code>ahcich0: Timeout on slot 12 port 0
ahcich0: is 00000000 cs 00003000 ss 00000000 rs 00003000 tfd 50 serr 00000000 cmd 00718c17
(ada0:ahcich0:0:0:0): WRITE_DMA. ACB: ca 00 50 8a 8b 41 00 00 00 00 d0 00
(ada0:ahcich0:0:0:0): CAM status: Command timeout
(ada0:ahcich0:0:0:0): Retrying command, 3 more tries remain
</code></pre>
<p>A reboot usually cures the problem. If this happens during install,
it's generally best to start over as performance is awful once timeouts
start.</p>
</li>
<li>
<p>The HDMI transmitter on the board might fail to detect if a monitor is
plugged in.
In such a case, the monitor will turn blank when the CheriBSD kernel starts
printing messages to the console, after the CheriBSD boot loader menu.
A user can configure the kernel to ignore hot plug detection and assume
that the attached monitor can receive HDMI input.
To do that, add the following line to <code>/boot/loader.conf</code> and reboot your
board:</p>
<pre><code>hw.tda19988.broken_hpd=&quot;1&quot;
</code></pre>
<p>While the screen itself should be working with this workaround, the user can
still experience EDID reading failures described below.</p>
</li>
<li>
<p>The HDMI transmitter on the board might fail to detect the monitor's
resolution.
The CheriBSD kernel writes the following message to the console in such a
case:</p>
<pre><code>tda0: Failed to read EDID
</code></pre>
<p>Currently, there is no workaround for this issue and it is likely to occur
with the HDMI transmitter issue described above.</p>
</li>
<li>
<p>The ZFS port is unstable with pure-capability kernels. While it does
support creation of file systems it hangs while mounting a ZFS root file
system either as a module or compiled in to the kernel. In general it is
lightly tested and should be used with caution.</p>
</li>
<li>
<p>We have witnessed one apparent deadlock in ZFS during an install.
Dozens of other installs have completed without issue so this is not
common.</p>
</li>
</ul>
<h2><a class="header" href="#issues-with-older-firmware" id="issues-with-older-firmware">Issues with older firmware</a></h2>
<p>The following issues affected users of older firmware revisions:</p>
<ul>
<li>
<p>Due to a firmware bug, OS-triggered reboot may lead the system to hang when
using older firmware.
Update your firmware or use the &quot;reboot&quot; command on the management console to
reboot the system once the OS has shut down.</p>
</li>
<li>
<p>Due to a firmware bug, some earlier firmware versions are not able to
persist UEFI configuration variables.
This affects, for example, the installation environment as the OS installer
cannot instruct the firmware to boot only from the installed target, and not
further USB sticks.</p>
</li>
</ul>
<p><strong>It is extremely important that you use the most recent firmware with your
Morello board, to avoid these and other issues present in earlier firmware
releases.</strong></p>
<h1><a class="header" href="#third-party-packages" id="third-party-packages">Third-party packages</a></h1>
<p>CheriBSD on Morello ships with CheriABI, hybrid ABI and benchmark ABI packages
(compilations) of the CheriBSD ports collection, each targeting a different
form of code generation and Application Binary Interface (ABI).
They have different levels of completeness, maturity, security, and support.</p>
<p><a href="https://github.com/CTSRD-CHERI/cheribsd-ports">CheriBSD ports</a>
extends FreeBSD ports, a collection of over 34,000 third-party
software adaptations to FreeBSD, with CHERI- and CheriBSD-specific patches.
The
<a href="https://github.com/CTSRD-CHERI/cheribsd-ports/tree/releng/23.11">releng/23.11</a>
CheriBSD ports branch contains ports matching the packages built for the current
release.</p>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>The following table presents an overview of available package managers in
CheriBSD that are described in more details in consecutive sections.
You can also browse package repositories at
<a href="https://pkg.CheriBSD.org/">pkg.CheriBSD.org</a>
to check what packages are available for a specific ABI version.</p>
<table><thead><tr><th>ABI</th><th>#</th><th>Manager</th><th>Install path</th><th>Suitable for</th></tr></thead><tbody>
<tr><td>CheriABI</td><td>~10,000</td><td><code>pkg64c</code></td><td><code>/usr/local</code></td><td>Security evaluation</td></tr>
<tr><td>Benchmark ABI</td><td>~10,000</td><td><code>pkg64cb</code></td><td><code>/usr/local64cb</code></td><td>Performance evaluation</td></tr>
<tr><td>Hybrid ABI</td><td>~25,000</td><td><code>pkg64</code></td><td><code>/usr/local64</code></td><td>Day-to-day use</td></tr>
</tbody></table>
<h2><a class="header" href="#package-managers-in-cheribsd" id="package-managers-in-cheribsd">Package managers in CheriBSD</a></h2>
<p><em>Note:</em> As of this writing we only provide packages for Morello systems.</p>
<p>CheriBSD includes three package managers:</p>
<ul>
<li><code>pkg64c</code> for CheriABI packages;</li>
<li><code>pkg64cb</code> for benchmark ABI packages;</li>
<li><code>pkg64</code> for hybrid ABI packages.</li>
</ul>
<p>The FreeBSD package manager <code>pkg</code> is not available on CheriBSD.
We expect that <code>pkg64c</code> will be renamed to <code>pkg</code> in a future CheriBSD release.
The intention is that, over time, the CheriABI packages will become more
mature, and hence the preferred collection for day-to-day use.</p>
<p>The syntax of the <code>pkg64*</code> commands match the syntax of the <code>pkg</code>
command from FreeBSD.
You can find information on package manager commands in FreeBSD's <code>pkg</code> manual
pages shipped with CheriBSD, e.g. for the commands <code>pkg64 rquery</code> and
<code>pkg64c rquery</code>, execute <code>man pkg-rquery</code>.</p>
<p>Additionally, you can learn more about FreeBSD's package manager by reading the
<a href="https://www.freebsd.org/cgi/man.cgi?pkg(7)">pkg(8) manual page</a> online
and the <a href="https://docs.freebsd.org/en/books/handbook/ports/">FreeBSD Handbook chapter on packages and
ports</a>.</p>
<h2><a class="header" href="#cheriabi-packages" id="cheriabi-packages">CheriABI packages</a></h2>
<p><strong>CheriABI packages</strong> are compiled using pure-capability CHERI C/C++, and
employ fine-grained C/C++ memory protection.</p>
<p>These packages are considered appropriate for <strong>experimental use</strong> and
a <strong>security evaluation</strong> of CHERI-extended hardware-software stacks.
Their primary function is to provide necessary dependencies for efforts to port
software to CheriABI and to support CHERI demonstration and evaluation.
They are suitable for research and development of software that benefit from
spatial and temporal memory safety as well as software compartmentalisation.
They can also be used to investigate potential memory safety issues in
third-party software that are easier to detect and debug using a CHERI-enabled
hardware-software stack.</p>
<p>There are currently ~10,000 CheriABI packages available, including:</p>
<ul>
<li>
<p>Databases: <code>sqlite3</code>;</p>
</li>
<li>
<p>Development utilities: <code>autoconf</code>, <code>chericat</code>, <code>cmake</code>, <code>git</code>, <code>gmake</code>;</p>
</li>
<li>
<p>Editors: <code>nano</code>, <code>vim-tiny</code>;</p>
</li>
<li>
<p>GUI environment: <code>cheri-desktop</code> (<code>seatd</code>, <code>sddm</code>, <code>wayland</code>,
<code>plasma5-plasma-workspace</code>, <code>dolphin</code>, <code>kate</code>, <code>konsole</code>, <code>okular</code>);</p>
</li>
<li>
<p>Hypervisor tools: <code>cheri-vm-support</code> (<code>u-boot-bhyve-arm64</code>);</p>
</li>
<li>
<p>Language interpreters: <code>perl5</code>, <code>tcl86</code>;</p>
</li>
<li>
<p>Libraries: <code>libnghttp2</code>, <code>libressl</code>, <code>libssh2</code>, <code>lzlib</code>;</p>
</li>
<li>
<p>Networking tools: <code>rsync31</code>;</p>
</li>
<li>
<p>Shells: <code>bash</code>, <code>dash</code>;</p>
</li>
<li>
<p>System tools: <code>sudo</code>, <code>tmux</code>.</p>
</li>
</ul>
<p>The packages are installed in the standard <code>/usr/local</code> hierarchy as they match
the base system ABI.</p>
<h2><a class="header" href="#benchmark-abi-packages" id="benchmark-abi-packages">Benchmark ABI packages</a></h2>
<p><strong>Benchmark ABI packages</strong> are compiled similarly to CheriABI packages, but
differ in generated code that takes into account current limitations of the
Morello architecture.
You should make sure to read the
<a href="packages/../benchmarking/">Benchmarking guidance</a>
section before using the benchmark ABI packages to understand the differences
between CheriABI and the benchmark ABI.</p>
<p>These packages are considered appropriate for a <strong>performance evaluation</strong> of
the Arm Morello architecture and third-party software executed on it.
They should not be used for a security evaluation, in which case you should use
CheriABI instead.</p>
<p>There are currently ~10,000 benchmark ABI packages available which should
include almost all packages that are available in the CheriABI package
repository.</p>
<p>The packages are installed in the <code>/usr/local64cb</code> hierarchy.
By default, <code>/usr/local64cb/bin</code> and <code>/usr/local64cb/sbin</code> are included in your
<code>PATH</code> environment variable of a shell shipped with CheriBSD.
If you are planning to use a custom shell, remember to add these paths to
<code>PATH</code>.</p>
<p>Different numbers of CheriABI and benchmark ABI packages is a result of using a
custom local base path (<code>/usr/local64cb</code>) and a custom <code>LD_LIBRARY_PATH</code>
variable name (<code>LD_64CB_LIBRARY_PATH</code>) for the benchmark ABI.
Multiple ports do not correctly handle these differences.</p>
<h2><a class="header" href="#hybrid-abi-packages" id="hybrid-abi-packages">Hybrid ABI packages</a></h2>
<p><strong>Hybrid ABI packages</strong> are compiled almost identically to packages in the
baseline non-CHERI architecture (e.g., Armv8-a for Morello, and 64-bit
RISC-V for RISC-V), and do not have improvements in memory protection or
software compartmentalization.</p>
<p>These packages are considered <em>appropriate for day-to-day use</em>.
They are intended to provide stable versions of tools necessary to develop
software and use your CHERI system while more software is ported to CheriABI.</p>
<p>There are currently ~25,000 hybrid ABI packages available, including:</p>
<ul>
<li>
<p>Browsers: <code>chromium</code>, <code>firefox</code>;</p>
</li>
<li>
<p>Compilers:</p>
<ul>
<li>
<p><code>llvm-morello</code>;</p>
<p>Includes Clang (a CHERI C/C++ compiler), LLD (a linker), and the LLVM
infrastructure for the Arm Morello architecture.
Binaries installed with this package have the suffix <code>-morello</code>.</p>
</li>
<li>
<p><code>llvm</code>;</p>
<p>Adds links in <code>/usr/local64/bin</code> to allow the <code>llvm-morello</code> package to be
used as the default LLVM package, without the suffix <code>-morello</code>,
e.g. <code>clang</code> instead of <code>clang-morello</code>.</p>
</li>
<li>
<p><code>llvm-base</code>;</p>
<p>Adds links in <code>/usr/bin</code> to allow the <code>llvm</code> package to be used in place of
a base-system toolchain. The <code>cc</code> script installed with this package adds
compiler flags required to natively compile code for a CHERI-enabled
architecture.</p>
</li>
<li>
<p><code>rust</code>.</p>
</li>
</ul>
</li>
<li>
<p>Debuggers: <code>gdb</code>;</p>
</li>
<li>
<p>Development utilities: <code>meson</code>, <code>ninja</code>;</p>
</li>
<li>
<p>Editors: <code>emacs</code>;</p>
</li>
<li>
<p>Language interpreters: <code>lua54</code>, <code>python39</code>, <code>ruby</code>;</p>
</li>
<li>
<p>Shells: <code>fish</code>, <code>zsh</code>.</p>
</li>
</ul>
<p>The packages are installed in the <code>/usr/local64</code> hierarchy.
By default, <code>/usr/local64/bin</code> and <code>/usr/local64/sbin</code> are included in your
<code>PATH</code> environment variable of a shell shipped with CheriBSD.
If you are planning to use a custom shell, remember to add these paths to
<code>PATH</code>.</p>
<h1><a class="header" href="#limitations-of-packages" id="limitations-of-packages">Limitations of packages</a></h1>
<p>When using or even considering third-party software delivered with CheriBSD
packages, it is important to keep in mind the maturity of currently available
CheriABI packages, and potential conflicts between hybrid ABI and CheriABI
packages.
The following sections describe some of such limitations.</p>
<h2><a class="header" href="#maturity-of-cheriabi-packages" id="maturity-of-cheriabi-packages">Maturity of CheriABI packages</a></h2>
<p>There are many projects that must still be ported to CHERI in order to provide
a fully-functional CheriABI package repository.
The available CheriABI packages are also not continuously tested as part of the
CheriBSD package building infrastructure.</p>
<p>CheriABI packages compile, but many have CHERI-related warnings that have not
been audited, and only a limited set have been tested.
Whilst the CheriABI packages are more interesting as they use CHERI
memory-safety features, they might break at run time and hence might not be
suitable for critical operations.
In such cases, a corresponding hybrid ABI package might be better suited than
the CheriABI package.</p>
<p>We expect the number of available and tested packages to grow with future
CheriBSD releases, but it will take quite some time until we are able to provide
a CheriABI package repository that covers functionalities currently included
in the hybrid ABI package repository.</p>
<p>We encourage everyone to report bugs related to CHERI support in the
<a href="https://github.com/CTSRD-CHERI/cheribsd-ports/issues">CheriBSD ports issue tracker</a>.</p>
<h2><a class="header" href="#separate-local-bases-for-abis" id="separate-local-bases-for-abis">Separate local bases for ABIs</a></h2>
<p>Upstream FreeBSD does not have the ability to manage packages for multiple ABIs
at the same time and its <code>pkg</code> package manager installs all packages in the
default local base path (<code>/usr/local</code>).
CheriBSD introduces a workaround for this issue by using separate local base
paths for different package repositories.</p>
<p>The hybrid ABI packages are compiled with a local base set to <code>/usr/local64</code>
while the CheriABI packages use the default local base.
Because the hybrid ABI packages are installed in a non-standard location, there
may be bugs resulting in hybrid ABI packages looking for its dependencies in
<code>/usr/local</code> instead of <code>/usr/local64</code>.
For example, a CheriBSD port a package was built from might fail to configure
a project's build system to use this custom local base, or an upstream project
might hardcode <code>/usr/local</code> in its source code.</p>
<p>We encourage everyone to report bugs related to invalid local base paths in the
hybrid ABI packages in our
<a href="https://github.com/CTSRD-CHERI/cheribsd-ports/issues">CheriBSD ports issue tracker</a>.</p>
<h2><a class="header" href="#cross-abi-package-conflicts" id="cross-abi-package-conflicts">Cross-ABI package conflicts</a></h2>
<p>Hybrid ABI and CheriABI package repositories include many counterpart packages,
e.g. <code>git</code> is available in both repositories.
CheriABI packages have a higher priority than the hybrid ABI packages in default
<code>PATH</code> environment variables in CheriBSD.
If you install a CheriABI package and a hybrid ABI package with a conflicting
program name, you must execute the hybrid ABI program using an absolute path by
default.</p>
<p>When using a shell configuration not included in CheriBSD's source code, a user
must remember to appropriately set the <code>PATH</code> environment variable to take into
account both <code>/usr/local</code> and <code>/usr/local64</code> paths.
The user can set the order of the paths they prefer but it is recommended to
place <code>/usr/local</code> before <code>/usr/local64</code> in such configurations to match
CheriBSD's defaults.</p>
<h2><a class="header" href="#cross-abi-package-dependencies" id="cross-abi-package-dependencies">Cross-ABI package dependencies</a></h2>
<p>At the moment, a package cannot depend at run time on another package with
a different ABI, e.g. to execute a program provided by that package.
Such a feature would be useful for CheriBSD ports which cannot easily be adapted
to CheriABI and which include programs that could be executed by other ports
already adapted to CheriABI.
There are currently no plans to support this case.</p>
<h1><a class="header" href="#missing-packages" id="missing-packages">Missing packages</a></h1>
<p>Hybrid ABI and CheriABI package repositories might be missing third-party
software due to the following reasons:</p>
<ul>
<li>
<p>There is no FreeBSD port including that software or it is broken on AArch64;</p>
<p>Check <a href="https://www.freshports.org/">FreshPorts</a>,
<a href="https://wiki.freebsd.org/WantedPorts">FreeBSD Wiki</a>,
<a href="https://bugs.freebsd.org/bugzilla/">FreeBSD Bugzilla</a> and
the <a href="https://lists.freebsd.org/subscription/freebsd-ports">freebsd-ports mailing
list</a> to find out
if anyone is working on software you are interested in.</p>
</li>
<li>
<p>A CheriBSD port with the software is broken on Morello (e.g., it is not
adapted to CheriABI), or does not respect a custom local base (<code>/usr/local64</code>)
when compiled for the hybrid ABI.</p>
<p>Check the <a href="https://github.com/CTSRD-CHERI/cheribsd-ports/issues">CheriBSD ports issue
tracker</a> to find out if
an issue with the software is documented and the <a href="https://poudriere.cheribsd.org">Poudriere infrastructure for
CheriBSD packages</a> to find failed build logs
and skipped build causes.</p>
</li>
</ul>
<h1><a class="header" href="#upgrading-packages" id="upgrading-packages">Upgrading packages</a></h1>
<p>It is recommended to upgrade packages in the following situations:</p>
<ul>
<li>
<p>Before building a newer CheriBSD release;</p>
<p>The release might require an updated toolchain (e.g., due to ABI changes in
the release that must be supported by the toolchain).</p>
</li>
<li>
<p>After updating your host to a newer CheriBSD release;</p>
<p>Package repositories are compiled for the ABI version used by the
corresponding release, which might differ from the ABI of the previous
release.</p>
<p>Where practical, we intend to support packages from the immediately prior
release on the newer release, but will make no effort to ensure that package
repositories from even older releases continue to work.</p>
<p>Additionally, package repositories for the newer release will most likely
include updated third-party software versions that are tested against that
release.</p>
</li>
<li>
<p>After finding a bug in a package (e.g., a library, a toolchain).</p>
<p>It might happen that the bug you discovered has already been reported and
fixed.
If the package upgrade does not resolve your issue, please
<a href="packages/../support/">report the bug</a>.</p>
</li>
</ul>
<p>Use the following commands to upgrade your packages:</p>
<table><thead><tr><th>CheriABI</th><th>Hybrid ABI</th></tr></thead><tbody>
<tr><td><code>pkg64c upgrade</code></td><td><code>pkg64 upgrade</code></td></tr>
</tbody></table>
<p>If you do not want perform the upgrade itself but only check if newer versions
are available, use the <code>-n</code> flag:</p>
<table><thead><tr><th>CheriABI</th><th>Hybrid ABI</th></tr></thead><tbody>
<tr><td><code>pkg64c upgrade -n</code></td><td><code>pkg64 upgrade -n</code></td></tr>
</tbody></table>
<p>You can read more on the <code>upgrade</code> command at
<a href="https://www.freebsd.org/cgi/man.cgi?pkg-upgrade(8)">pkg-upgrade(8)</a>
or in your console with <code>man pkg-upgrade</code>.</p>
<h1><a class="header" href="#debugging-packages" id="debugging-packages">Debugging packages</a></h1>
<p>Similarly to the FreeBSD Project, CheriBSD packages are built with CheriBSD
ports that are based on FreeBSD ports.
By default, the packages are built with optimisation levels defined in CheriBSD
ports or upstream third-party software projects.
Unfortunately, the FreeBSD ports build system does not allow to build ports with
optimisations and debug symbols at the same time.
As a consequence of that, you might discover that debug symbols are missing when
debugging a program with the GDB debugger.</p>
<p>In order to allow users to use optimised and debug CheriABI packages, CheriBSD
provides two package repositories with them: the default repository with
optimisations and without debug symbols called <code>CheriBSD</code>, and the debug
repository without optimisations and with debug symbols called <code>CheriBSD-debug</code>.
Note that we do not provide debug packages for the hybrid and benchmark ABIs.</p>
<p>You can enable the debug repository by first creating a directory for custom
package repository configuration files:</p>
<pre><code>mkdir -p /usr/local/etc/pkg/repos
</code></pre>
<p>and then creating a configuration file that enables <code>CheriBSD-debug</code>:</p>
<pre><code>echo &quot;CheriBSD-debug: { enabled: yes }&quot; &gt;/usr/local/etc/pkg/repos/CheriBSD-debug.conf
</code></pre>
<p>You can reinstall all previously installed default packages to replace them with
debug packages:</p>
<pre><code>pkg64c upgrade -fr CheriBSD-debug
</code></pre>
<p>Alternatively, you can selectively reinstall a package:</p>
<pre><code>pkg64c upgrade -r CheriBSD-debug &lt;pkg-name&gt;
</code></pre>
<p>However, keep in mind that in such case only the package you list is
reinstalled, leaving its dependencies intact.</p>
<p>Once you enable the <code>CheriBSD-debug</code> repository, the <code>CheriBSD</code> repository is
used by default.
You have to use the <code>-r</code> flag to switch to <code>CheriBSD-debug</code> in a <code>pkg64c</code>
command, e.g.:</p>
<pre><code>pkg64c install -r CheriBSD-debug &lt;pkg-name&gt;
</code></pre>
<p>If you want to use only the <code>CheriBSD-debug</code> repository, you can create a
configuration file that disables the <code>CheriBSD</code> repository:</p>
<pre><code>echo &quot;CheriBSD: { enabled: no }&quot; &gt; /usr/local/etc/pkg/repos/CheriBSD.conf
</code></pre>
<p>You can also check if an installed package was fetched from the default or debug
package repository:</p>
<pre><code>pkg64c query '%n %R' &lt;pkg-name&gt;
</code></pre>
<p>You can omit <code>&lt;pkg-name&gt;</code> in the above command to list all packages with their
repositories.</p>
<h1><a class="header" href="#useful-commands" id="useful-commands">Useful commands</a></h1>
<p>The following list includes useful commands to manage packages.
Replace <code>&lt;pkg&gt;</code> with <code>pkg64c</code> to execute a command in the context of CheriABI
packages and with <code>pkg64</code> in the context of hybrid ABI packages.</p>
<p>Most <code>pkg</code> commands have separate man pages describing them.
For a command <code>&lt;pkg&gt; foo</code>, you can read its man page by executing <code>man pkg-foo</code>
on a CheriBSD host.</p>
<ul>
<li>List available package manager commands:
<pre><code>&lt;pkg&gt; help
</code></pre>
</li>
<li>Read more information on a package manager command:
<pre><code>&lt;pkg&gt; help &lt;command&gt;
</code></pre>
</li>
<li>Search a package repository:
<pre><code>&lt;pkg&gt; search &lt;pattern&gt;
</code></pre>
</li>
<li>Search a package repository and display full information:
<pre><code>&lt;pkg&gt; search --full &lt;pattern&gt;
</code></pre>
</li>
<li>List installed packages:
<pre><code>&lt;pkg&gt; info
</code></pre>
</li>
<li>Display information for an installed package:
<pre><code>&lt;pkg&gt; info &lt;pkg-name&gt;
</code></pre>
</li>
<li>Install a package:
<pre><code>&lt;pkg&gt; install &lt;pkg-name&gt;
</code></pre>
</li>
<li>Delete a package:
<pre><code>&lt;pkg&gt; delete &lt;pkg-name&gt;
</code></pre>
</li>
<li>Delete packages that are no longer required:
<pre><code>&lt;pkg&gt; autoremove
</code></pre>
</li>
<li>Check a new package version for an installed package:
<pre><code>&lt;pkg&gt; upgrade -n &lt;pkg-name&gt;
</code></pre>
</li>
<li>Check new package versions for all installed packages:
<pre><code>&lt;pkg&gt; upgrade -n
</code></pre>
</li>
<li>Upgrade a package after confirmation:
<pre><code>&lt;pkg&gt; upgrade &lt;pkg-name&gt;
</code></pre>
</li>
<li>Upgrade all packages after confirmation:
<pre><code>&lt;pkg&gt; upgrade
</code></pre>
</li>
<li>Display which package installed a file:
<pre><code>&lt;pkg&gt; which /path/to/file
</code></pre>
</li>
<li>Check a number of installed packages:
<pre><code>&lt;pkg&gt; stats -l
</code></pre>
</li>
<li>Check a number of available packages:
<pre><code>&lt;pkg&gt; stats -r
</code></pre>
</li>
</ul>
<h1><a class="header" href="#compiling-hello-world" id="compiling-hello-world">Compiling &quot;Hello World&quot;</a></h1>
<p>These instructions are intended for use on an Arm Morello board, and install
hybrid ABI versions of key toolchain and utilities using <code>pkg64</code>.
The commands will (eventually) work the same on CHERI-RISC-V, but output
details and registers in GDB will differ.</p>
<h2><a class="header" href="#toolchain-installation" id="toolchain-installation">Toolchain installation</a></h2>
<p>You will need the Morello LLVM toolchain and Morello GDB for this
exercise. To install LLVM, use the command:</p>
<p><code>pkg64 install llvm-base</code></p>
<p>If this is the first time you are using <code>pkg64</code> on this system, you will
be prompted to bootstrap the <code>pkg</code> package before the package database
is downloaded and you are prompted to confirm before installing <code>llvm</code>
and its dependencies:</p>
<pre><code>root@cheribsd:~ # pkg64 install llvm-base
The package management tool is not yet installed on your system.
Do you want to fetch and install it now? [y/N]: y
Bootstrapping pkg from pkg+http://pkg.CheriBSD.org/CheriBSD:20220314:aarch64, please wait...
Verifying signature with trusted certificate pkg.cheribsd.org.2022032901... done
Installing pkg-1.17.5_1...
Extracting pkg-1.17.5_1: 100%
Updating CheriBSD repository catalogue...
Fetching meta.conf: 100%    163 B   0.2kB/s    00:01
Fetching packagesite.pkg: 100%    4 MiB   1.4MB/s    00:03
Processing entries: 100%
CheriBSD repository update completed. 20954 packages processed.
All repositories are up to date.
Updating database digests format: 100%
The following 12 package(s) will be affected (of 0 checked):

New packages to be INSTALLED:
        gettext-runtime: 0.21
        indexinfo: 0.3.1
        libedit: 3.1.20210910,1
        libffi: 3.3_1
        libxml2: 2.9.13_2
        llvm: 13,1
        llvm-base: 1
        llvm-morello: 13.0.d20220502_1
        mpdecimal: 2.5.1
        perl5: 5.32.1_1
        python38: 3.8.13
        readline: 8.1.2

Number of packages to be installed: 12

The process will require 902 MiB more space.
190 MiB to be downloaded.

Proceed with this action? [y/N]: y
[1/12] Fetching llvm-base-1.pkg: 100%    3 KiB   2.8kB/s    00:01
[2/12] Fetching llvm-13,1.pkg: 100%   11 KiB  11.2kB/s    00:01
...
[12/12] Fetching libedit-3.1.20210910,1.pkg: 100%  119 KiB 121.8kB/s    00:01
Checking integrity... done (0 conflicting)
[1/12] Installing indexinfo-0.3.1...
[1/12] Extracting indexinfo-0.3.1: 100%
...
[12/12] Installing llvm-base-1...
[12/12] Extracting llvm-base-1: 100%
=====
...

</code></pre>
<p><em>Note:</em> By default FreeBSD ships with the <code>vi</code> and <code>ee</code> editors. You may
wish to install the <code>nano</code> or <code>vim</code> package to access a
more familiar editor. Currently only hybrid packages installable with
<code>pkg64</code> are available.</p>
<h2><a class="header" href="#source-code" id="source-code">Source code</a></h2>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int
main(void)
{
	printf(&quot;Hello world\n&quot;);
}
</code></pre>
<h2><a class="header" href="#building-for-cheriabi" id="building-for-cheriabi">Building for CheriABI</a></h2>
<p>To build a CheriABI Hello World program use:</p>
<p><code>cc -g -O2 -Wall -o helloworld helloworld.c</code></p>
<p>You can verify this is a CheriABI binary with the <code>file</code> command:</p>
<pre><code>root@cheribsd:~ # file helloworld
helloworld: ELF 64-bit LSB pie executable, ARM aarch64, C64, CheriABI, version 1 (SYSV), dynamically linked, interpreter /libexec/ld-elf.so.1, for FreeBSD 14.0 (1400094), FreeBSD-style, with debug_info, not stripped
</code></pre>
<h2><a class="header" href="#building-for-the-benchmark-abi" id="building-for-the-benchmark-abi">Building for the Benchmark ABI</a></h2>
<p>To target the <a href="helloworld/../benchmarking/">Benchmark ABI</a>, add the argument
<code>-mabi=purecap-benchmark</code> to the <code>cc</code> command line:</p>
<p><code>cc -g -O2 -Wall -mabi=purecap-benchmark -o helloworld helloworld.c</code></p>
<p>You can verify this is a Benchmark ABI binary with the <code>file</code> command:</p>
<pre><code>root@cheribsd:~ # file helloworld
helloworld: ELF 64-bit LSB pie executable, ARM aarch64, C64, CheriABI, version 1 (SYSV), dynamically linked, interpreter /libexec/ld-elf.so.1, for FreeBSD 14.0 (1400094), FreeBSD-style, pure-capability benchmark ABI, with debug_info, not stripped
</code></pre>
<h2><a class="header" href="#running" id="running">Running</a></h2>
<p>Run the program:</p>
<pre><code>root@cheribsd:~ # ./helloworld
Hello world
</code></pre>
<h2><a class="header" href="#debugging" id="debugging">Debugging</a></h2>
<p>First, if it is not already installed, install the CHERI GDB debugger:</p>
<p><code>pkg64 install gdb-cheri</code></p>
<p>You can then debug <code>helloworld</code> by running GDB and setting a breakpoint
on <code>main</code>:</p>
<pre><code>root@cheribsd:~ # gdb ./helloworld
GNU gdb (GDB) 12.1
...
Reading symbols from ./helloworld...
...
(gdb) b main
Breakpoint 1 at 0x10a14: file helloworld.c, line 6.
(gdb) r
Starting program: /root/helloworld

Breakpoint 1, main () at helloworld.c:6
6           printf(&quot;Hello world\n&quot;);
(gdb) 
</code></pre>
<p>If you then step into the <code>printf</code> (or <code>puts</code> depending on
optimization level) call you will see that GDB prints the capability
argument with expanded information including bounds and permissions:</p>
<pre><code>(gdb) s
puts (s=0x1006e0 [rR,0x1006e0-0x1006ec] &quot;Hello world&quot;)
    at /home/bed22/cheri/cheribsd/lib/libc/stdio/puts.c:60
60      /home/bed22/cheri/cheribsd/lib/libc/stdio/puts.c: No such file or directory.
</code></pre>
<p>The argument can also be examined directly as either an integer or capability register:</p>
<pre><code>(gdb) info reg x0
x0             0x1006e0            1050336
(gdb) info reg c0
c0             0x905f400046ec06e000000000001006e0 0x1006e0 [rR,0x1006e0-0x1006ec]
(gdb)
</code></pre>
<p>If a capability (either in memory or a register) contains a
null-derived value, it is displayed as a simple scalar value without
any attributes.  If a capability is not null-derived but is untagged,
the string &quot;(invalid)&quot; is displayed after the bounds.</p>
<p>Capability tags in memory can also be examined by passing the &quot;m&quot;
flag to the eXamine command.  For example, compare the output of the
internal FILE structure used for stdout in libc:</p>
<pre><code>(gdb) p *__stdoutp
$1 = {_p = 0x0, _r = 0, _w = 0, _flags = 8, _file = 1, _bf = {_base = 0x0, 
    _size = 0}, _lbfsize = 0, 
  _cookie = 0x403a8400 [rwRWE,0x403a8230-0x403a87a0], 
  _close = 0x402bade5 &lt;__sclose&gt; [rxRE,0x4018e000-0x407f0000] (sentry), 
  _read = 0x402bada5 &lt;__sread&gt; [rxRE,0x4018e000-0x407f0000] (sentry), 
  _seek = 0x402baddd &lt;__sseek&gt; [rxRE,0x4018e000-0x407f0000] (sentry), 
  _write = 0x402badc1 &lt;__swrite&gt; [rxRE,0x4018e000-0x407f0000] (sentry), _ub = {
    _base = 0x0, _size = 0}, _up = 0x0, _ur = 0, _ubuf = &quot;\000\000&quot;, 
  _nbuf = &quot;&quot;, _lb = {_base = 0x0, _size = 0}, _blksize = 0, _offset = 0, 
  _fl_mutex = 0x0, _fl_owner = 0x0, _fl_count = 0, _orientation = 0, 
  _mbstate = {__mbstate8 = '\000' &lt;repeats 127 times&gt;, _mbstateL = 0, 
    _mbstateP = 0x0 }, _flags2 = 0}
(gdb) x/16gxm __stdoutp
&lt;CHERI Tag 0 for range [0x403a8400,0x403a8410)&gt;
0x403a8400:     0x0000000000000000      0x0000000000000000
&lt;CHERI Tag 0 for range [0x403a8410,0x403a8420)&gt;
0x403a8410:     0x0000000000000000      0x0000000000010008
&lt;CHERI Tag 0 for range [0x403a8420,0x403a8430)&gt;
0x403a8420:     0x0000000000000000      0x0000000000000000
&lt;CHERI Tag 0 for range [0x403a8430,0x403a8440)&gt;
0x403a8430:     0x0000000000000000      0x0000000000000000
&lt;CHERI Tag 0 for range [0x403a8440,0x403a8450)&gt;
0x403a8440:     0x0000000000000000      0x0000000000000000
&lt;CHERI Tag 1 for range [0x403a8450,0x403a8460)&gt;
0x403a8450:     0x00000000403a8400      0xdc5fc00047a08230
&lt;CHERI Tag 1 for range [0x403a8460,0x403a8470)&gt;
0x403a8460:     0x00000000402bade5      0xb05fc000bf0618e7
&lt;CHERI Tag 1 for range [0x403a8470,0x403a8480)&gt;
0x403a8470:     0x00000000402bada5      0xb05fc000bf0618e7
</code></pre>
<h1><a class="header" href="#benchmarking-guidance" id="benchmarking-guidance">Benchmarking guidance</a></h1>
<p>CheriBSD is a research operating system designed to run on experimental
hardware.
In this section, we provide high-level guidance on configuring CheriBSD for
software benchmarking.</p>
<h1><a class="header" href="#framing" id="framing">Framing</a></h1>
<p>The expectation of this section is that a performance comparison is being
made between baseline aarch64-compiled software (64-bit Arm) and memory-safe
aarch64c software (CheriABI) on the Arm Morello board.</p>
<p>Before proceeding to the remainder of this section, it is essential to first
read <a href="https://ctsrd-cheri.github.io/morello-early-performance-results/cover/index.html">Early performance results from the prototype Morello
microarchitecture</a>.
That document provides detailed information on how to interpret performance
measurements, including documenting known limitations of the prototype
Morello microarchitecture.</p>
<p>A key conclusion from that work is that CheriABI software being used for
performance measurement should be compiled for the aarch64cb &quot;Benchmark ABI&quot;,
and not aarch64c.</p>
<h1><a class="header" href="#kernel-configuration" id="kernel-configuration">Kernel configuration</a></h1>
<p>Depending on the version of CheriBSD you are using, the kernel may have a
number of debugging fetures enabled.
These features can substantially impact system performance, including
inducing disproportionate performance overhead for specific system behaviours.
For example, enabling kernel lock-order checking (&quot;WITNESS&quot;) will introduce
substantial overhead, and in particular will impact kernel-centric workloads
that make more intensive use of locks, such as networking.
During boot, CheriBSD will add the following lines to <code>/etc/motd</code>, which will
be displayed at login, to warn you about the &quot;INVARIANTS&quot; and &quot;WITNESS&quot;
debugging features:</p>
<pre><code>WARNING: INVARIANTS kernel option defined, expect reduced performance
WARNING: WITNESS kernel option defined, expect reduced performance
</code></pre>
<p>Performance measurements employing a hybrid kernel should use the
<code>kernel.GENERIC-MORELLO-NODEBUG</code> configuration when kernel memory safety is
not required.
The following line can be added to <code>/boot/loader.conf</code>:</p>
<pre><code>kernel=&quot;kernel.GENERIC-MORELLO-NODEBUG&quot;
</code></pre>
<p>Measurements requiring a memory-safe kernel should use the
<code>kernel.GENERIC-MORELLO-PURECAP-NODEBUG</code> configuration.
The following can be added to <code>/boot/loader.conf</code>:</p>
<pre><code>kernel=&quot;kernel.GENERIC-MORELLO-PURECAP-NODEBUG&quot;
</code></pre>
<p>You will need to reboot in order for this change to take effect.</p>
<h1><a class="header" href="#heap-temporal-memory-safety" id="heap-temporal-memory-safety">Heap temporal memory safety</a></h1>
<p>As of CheriBSD 23.11, userlevel heap temporal safety is enabled by default with jemalloc as the memory allocator.
This support is experimental, and has not yet been through significant
performance analysis and optimization.
We recommend disabling temporal safety support for the full system during
benchmarking not specifically intended to capture temporal safety
performance.
During boot, CheriBSD will add the following line to <code>/etc/motd</code>, which will
be displayed at login, to warn you about the temporal safety feature:</p>
<pre><code>WARNING: capability revocation enabled by default, this may affect performance
</code></pre>
<p>The following line can be added to <code>/boot/loader.conf</code>:</p>
<pre><code>security.cheri.runtime_revocation_default=0
</code></pre>
<p>You will need to reboot in order for this change to take effect.</p>
<h1><a class="header" href="#the-benchmark-abi" id="the-benchmark-abi">The Benchmark ABI</a></h1>
<p>As of CheriBSD 23.11, CheriBSD supports the Benchmark ABI, a modified form of
code generation improving performance on the Arm Morello board.
This is required due to limitations on bounds prediction in the current
Morello prototype, which would be resolved in a production microarchitecture.
The performance of the Benchmark ABI is more predictive of potential future
CHERI microarchitectural performance than the Morello prototype running
software compiled for CheriABI, making it preferable for benchmarking.
However, this comes at the cost of reduce security, and so software compiled
for the Benchmark ABI should not be used for security evaluation.
Programs may be compiled to the Benchmark ABI using the
<code>-mabi=purecap-benchmark</code> command-line argument to <code>cc</code>.</p>
<p>More information on compiling with the Benchmark ABI can be found in
<a href="benchmarking/../helloworld/">Compiling Hello World</a>.
More information on what the Benchmark ABI is, and how to interpret
performance results, can be found in <a href="https://ctsrd-cheri.github.io/morello-early-performance-results/cover/index.html">Early performance results from the
prototype Morello
microarchitecture</a>.</p>
<h1><a class="header" href="#getting-help" id="getting-help">Getting help</a></h1>
<p>CheriBSD is a community-supported open-source research operating system.
While every effort has been made to engineer to a high quality, many aspects
of OS design for CHERI processors remain active research, and there are
constrained engineering resources available to build, maintain, and support
the system.
As you gain experience with CheriBSD, your help in supporting newcomers in the
community will be greatly appreciated.</p>
<h2><a class="header" href="#github-issue-tracker-and-pull-requests" id="github-issue-tracker-and-pull-requests">GitHub issue tracker and pull requests</a></h2>
<p>CheriBSD is developed and maintained in the <a href="https://github.com/CTSRD-CHERI/cheribsd">CheriBSD GitHub
repository</a>, which includes an issue
tracker in which bugs can be reported, as well as permitting pull requests to
be submitted.</p>
<p>This document is also maintained in a <a href="https://github.com/CTSRD-CHERI/cheribsd-getting-started">GitHub
repository</a>, and your
feedback and improvements would be very much appreciated.</p>
<h2><a class="header" href="#cheribsd-slack-on-cheri-cpuslackcom" id="cheribsd-slack-on-cheri-cpuslackcom">CheriBSDSlack on cheri-cpu.slack.com</a></h2>
<p>Support for CheriBSD is provided via the <a href="https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-slack.html">CHERI CPU
Slack</a>,
where a number of topic-specific channels can be found:</p>
<ul>
<li>
<p><code>#cheribsd</code>;</p>
<p>CheriBSD, its features, releases and future plans.</p>
</li>
<li>
<p><code>#debuggers</code>;</p>
<p>GDB extended to support CHERI.</p>
</li>
<li>
<p><code>#qemu</code>;</p>
<p>QEMU-CHERI, QEMU system and user modes for Morello and CHERI-RISC-V.</p>
</li>
<li>
<p><code>#software-porting</code>.</p>
<p>Third-party software adaptations to CheriABI and CHERI-enabled achitectures,
CheriBSD ports and Poudriere.</p>
</li>
</ul>
<h2><a class="header" href="#cheribsd-mailing-lists" id="cheribsd-mailing-lists">CheriBSD mailing lists</a></h2>
<p>There are also several CheriBSD email lists available:</p>
<ul>
<li><a href="https://lists.cam.ac.uk/sympa/info/cl-cheribsd-announce">CheriBSD announcement mailing list (low volume)</a></li>
<li><a href="https://lists.cam.ac.uk/sympa/info/cl-cheribsd-discuss">CheriBSD general discussion</a></li>
<li><a href="https://lists.cam.ac.uk/sympa/info/cl-cheribsd-ports">CheriBSD ports and packages discussion</a></li>
<li>CheriBSD security vulnerabilities contact address <a href="mailto:cl-cheribsd-security@lists.cam.ac.uk">cl-cheribsd-security@lists.cam.ac.uk</a> </li>
</ul>
<h2><a class="header" href="#in-person-events-and-meetings" id="in-person-events-and-meetings">In-person events and meetings</a></h2>
<p>You can meet with the CheriBSD developers at a number of conferences and other
events, including:</p>
<ul>
<li>
<p>UKRI Digital Security by Design (DSbD) All Hands meetings that take place in
the UK twice annually to discuss the Morello architecture, board, and its
use.</p>
</li>
<li>
<p>FreeBSD developer summits and conferences around the world, including (when
it takes place) the BSDCan conference in Canada, and the EuroBSDCon
conference in Europe.</p>
</li>
</ul>
<p>There is discussion around creating further, more frequent CHERI workshops in
the UK in the future.</p>
<p>Most CheriBSD developers are based at the University of Cambridge (UK) and SRI
International (USA), and it is possible to set up meetings with them directly.
Get in touch if this would be useful to you.</p>
<h1><a class="header" href="#resources" id="resources">Resources</a></h1>
<p>In addition to the <a href="resources/../support/">CheriBSD support channels</a>, the
following resources may also be useful.</p>
<h2><a class="header" href="#cheribsd-1" id="cheribsd-1">CheriBSD</a></h2>
<ul>
<li><a href="https://www.cheribsd.org/">CheriBSD website</a></li>
</ul>
<h2><a class="header" href="#cheri-1" id="cheri-1">CHERI</a></h2>
<ul>
<li><a href="https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/">CHERI project
website</a></li>
<li><a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-941.pdf">An Introduction to
CHERI</a></li>
<li><a href="https://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-947.pdf">The CHERI C/C++ Programming
Guide</a></li>
</ul>
<h2><a class="header" href="#freebsd" id="freebsd">FreeBSD</a></h2>
<ul>
<li><a href="https://docs.freebsd.org/en/books/handbook/">The FreeBSD Handbook</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
